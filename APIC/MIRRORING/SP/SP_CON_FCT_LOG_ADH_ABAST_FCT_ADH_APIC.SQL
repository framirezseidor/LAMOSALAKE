
CREATE OR REPLACE PROCEDURE CON.SP_CON_FCT_LOG_ADH_ABAST_FCT_ADH_APIC()
RETURNS VARCHAR(1000)
LANGUAGE SQL
EXECUTE AS OWNER
AS
$$
/*
---------------------------------------------------------------------------------
 Versión:            1.0
 Fecha de creación:  2025-09-15
 Creador:            Fidel Ramírez
 Descripción:        carga de datos a la fact del modelo unificado APIC
---------------------------------------------------------------------------------
*/


/*
---------------------------------------------------------------------------------
 1.- Eliminamos los datos de la fact y hacemos carga desde la última extracción
 ---------------------------------------------------------------------------------
*/

BEGIN

    DELETE FROM MIRRORING.FCT_ADH_APIC
    WHERE
        MODELO = 'ABASTECIMIENTOS' ;
  
  
    INSERT INTO MIRRORING.FCT_ADH_APIC
    SELECT
        CONCAT(FECHA_CARGA, FECHA_ORDEN, ALMACENCENTRO_ID, MATERIALCENTRO_ID) AS APIC_ID,
        LEFT(ANIOMES,4) AS ANIO,
        RIGHT(ANIOMES,2) AS MES,
        REPLACE(ANIOMES,'-','') AS ANIOMES,
        FECHA_ORDEN AS FECHA_LOGISTICA,
        ALMACENCENTRO_ID AS ALMACENCENTRO_ID,
        SUBSTR(ALMACENCENTRO_ID,6,4) AS ALMACEN_ID,
        SUBSTR(ALMACENCENTRO_ID,1,4)  AS CENTRO_ID,
        SOCIEDAD_ID AS SOCIEDAD_ID,
        GRUPOCOMPRAS_ID AS GRUPOCOMPRAS_ID,
        ORGCOMPRAS_ID AS ORGCOMPRAS_ID,
        PROVEEDOR_ID AS PROVEEDOR_ID,
        MATERIALCENTRO_ID AS MATERIALCENTRO_ID,
        MATERIAL_ID AS MATERIAL_ID,
        '' AS CLASEMOVIMIENTO_ID,
        CLAVEOPERACION AS CLAVEOPERACION,
        ESTADO AS GRUPO_OPERACION,
        '' AS MOTIVOPEDIDO_ID,
        '' AS BOR_CLASEPEDIDO_ID,
        '' AS VTA_CLASEFACTURA_ID,
        '' AS VTA_GRUPO_TRANSACCION,
        '' AS VTA_TIPO_TRANSACCION,
        0 AS BOR_IND_BO_TOTAL_TON,
        0 AS VTA_IND_VENTA_PCP_LOC,
        0 AS VTA_IND_VENTA_PCP_TON,
        0 AS VTA_IND_VENTA_REAL_LOC,
        0 AS VTA_IND_VENTA_REAL_TON,
        0 AS INV_IND_BLOQUEADO_TON,
        0 AS INV_IND_BLOQUEADO_UMB,
        0 AS INV_IND_CONTROL_CALIDAD_TON,
        0 AS INV_IND_CONTROL_CALIDAD_UMB,
        0 AS INV_IND_COSTO_INV_LOC,
        0 AS INV_IND_INVENTARIO_FISICO_TON,
        0 AS INV_IND_INVENTARIO_FISICO_UMB,
        0 AS INV_IND_LIBRE_UTILIZACION_TON,
        0 AS INV_IND_LIBRE_UTILIZACION_UMB,
        0 AS INV_IND_LIBRE_VENTA_TON,
        0 AS INV_IND_LIBRE_VENTA_UMB,
        0 AS INV_IND_STOCK_SEGURIDAD_TON,
        0 AS INV_IND_STOCK_SEGURIDAD_UMB,
        0 AS INV_IND_TRANSITO_TON,
        0 AS INV_IND_TRANSITO_UMB,
        SUM(IND_CANTIDAD_TOTAL) AS ABS_IND_CANTIDAD_TOTAL,
        SUM(IND_CANT_DIAS_COLOCACION) AS ABS_IND_CANT_DIAS_COLOCACION,
        SUM(IND_CANT_POSICIONES_PEDIDO) AS ABS_IND_CANT_POSICIONES_PEDIDO,
        SUM(IND_IMPTE_COMPRA_LOC) AS ABS_IND_IMPTE_COMPRA_LOC,
        SUM(IND_IMPTE_COMPRA_PED) AS ABS_IND_IMPTE_COMPRA_PED,
        SUM(IND_IMPTE_COMPRA_USD) AS ABS_IND_IMPTE_COMPRA_USD,
        SUM(IND_IMPTE_COMPRA_SIN_FLETE_LOC) AS ABS_IND_IMPTE_COMPRA_SIN_FLETE_LOC,
        SUM(IND_IMPTE_COMPRA_SIN_FLETE_PED) AS ABS_IND_IMPTE_COMPRA_SIN_FLETE_PED,
        SUM(IND_IMPTE_COMPRA_SIN_FLETE_USD) AS ABS_IND_IMPTE_COMPRA_SIN_FLETE_USD,
        SUM(IND_IMPTE_FLETE_LOC) AS ABS_IND_IMPTE_FLETE_LOC,
        SUM(IND_IMPTE_FLETE_PED) AS ABS_IND_IMPTE_FLETE_PED,
        SUM(IND_IMPTE_FLETE_USD) AS ABS_IND_IMPTE_FLETE_USD,
        AVG(PRECIO_ESTANDAR_MXN) AS ABS_PRECIO_ESTANDAR_MXN ,
        AVG(PRECIO_ESTANDAR_ML) AS  ABS_PRECIO_ESTANDAR_ML,
        AVG(PRECIO_ESTANDAR_USD) AS ABS_PRECIO_ESTANDAR_USD ,
        UEN_ID ,
        0 AS PRD_IND_IMPTE_ML,
        0 AS PRD_IND_IMPTE_COMPRA_ML,
        0 AS PRD_IND_IMPTE_USD,
        0 AS PRD_IND_IMPTE_COMPRA_USD,
        0 AS PRD_IND_CANTIDAD_UMB,
        0 AS PRD_IND_CANTIDAD_UME,
        MON_LOC AS MON_LOC,
        MON_PED AS MON_PED,
        MON_USD AS MON_USD,
        UM_PEDIDO AS UNI_PED,
        '' AS UNI_EST,
        '' AS UNI_UMB,
        FECHA_CARGA AS FECHA_CARGA,
        MANDANTE AS MANDANTE,
        'ABASTECIMIENTOS' AS MODELO,
        SISORIGEN_ID AS SISORIGEN_ID,
        ZONA_HORARIA AS ZONA_HORARIA,
        CASE MONTH(FECHA_LOGISTICA)
            WHEN 1 THEN 'ENE'
            WHEN 2 THEN 'FEB'
            WHEN 3 THEN 'MAR'
            WHEN 4 THEN 'ABR'
            WHEN 5 THEN 'MAY'
            WHEN 6 THEN 'JUN'
            WHEN 7 THEN 'JUL'
            WHEN 8 THEN 'AGO'
            WHEN 9 THEN 'SEP'
            WHEN 10 THEN 'OCT'
            WHEN 11 THEN 'NOV'
            WHEN 12 THEN 'DIC'
        END AS MES_TEXTO
    FROM 
        MIRRORING.FCT_LOG_ADH_ABASTECIMIENTOS
    GROUP BY
        APIC_ID,
        ANIOMES,
        FECHA_LOGISTICA,
        ALMACENCENTRO_ID,
        ALMACEN_ID,
        CENTRO_ID,
        SOCIEDAD_ID,
        GRUPOCOMPRAS_ID,
        ORGCOMPRAS_ID,
        PROVEEDOR_ID,
        MATERIALCENTRO_ID,
        MATERIAL_ID,
        CLASEMOVIMIENTO_ID,
        CLAVEOPERACION,
        GRUPO_OPERACION,
        BOR_CLASEPEDIDO_ID,
        VTA_CLASEFACTURA_ID,
        VTA_TIPO_TRANSACCION,
        UEN_ID,
        MON_LOC,
        MON_PED,
        MON_USD,
        UNI_PED,
        UNI_EST,
        UNI_UMB,
        MANDANTE,
        MODELO,
        FECHA_CARGA,
        SISORIGEN_ID,
        ZONA_HORARIA ;

   --  RETURN CONCAT('Complete - Filas insertadas: ', (SELECT COUNT(0) FROM MIRRORING.FCT_ADH_APIC WHERE MODELO = 'ABASTECIMIENTOS') ); 
END;

$$
;
    