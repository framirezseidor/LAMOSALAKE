CREATE OR REPLACE ROW ACCESS POLICY SEGURIDAD.RAP_SAP_DIM_DESTINATARIO_ID
AS (
    COORDINADORDEST_ID VARCHAR(50),
    ASESORDEST_ID VARCHAR(50)
)
RETURNS BOOLEAN ->
CASE
    WHEN
        -- -- USUARIO TIENE SAP_ROLE
        (SELECT count(*) FROM SEGURIDAD.SEG_USUARIO_ROLE
        WHERE USER_NM = CURRENT_USER AND ROLE_NM = 'SAP_ROLE') > 0
    THEN TRUE
    -- Si ambos valores están presentes y el usuario tiene acceso a los dos → INNER JOIN lógico
    WHEN 
        (select SEGURIDAD.FN_LISTA_DIMS())=1 AND
        (
            (SELECT SEGURIDAD.FN_RAP_DIM(ASESORDEST_ID, 'ASESORDEST_ID')) = TRUE
            AND (SELECT SEGURIDAD.FN_RAP_DIM(COORDINADORDEST_ID, 'COORDINADORDEST_ID')) = TRUE
        ) = TRUE
        THEN TRUE

    WHEN 
        -- -- COORDINADOR_ID ESTA ESTABLECIDO SOLAMENTE
        (select SEGURIDAD.FN_LISTA_DIMS())=2 AND
        (SELECT SEGURIDAD.FN_RAP_DIM(COORDINADORDEST_ID, 'COORDINADORDEST_ID')) = TRUE
        THEN TRUE
    WHEN 
        -- -- ASESORDEST_ID ESTA ESTABLECIDO SOLAMENTE
        (select SEGURIDAD.FN_LISTA_DIMS())=3 AND
        (SELECT SEGURIDAD.FN_RAP_DIM(ASESORDEST_ID, 'ASESORDEST_ID')) = TRUE
        THEN TRUE    
    WHEN 
        -- -- NINGUNO ASIGNADO
        (select SEGURIDAD.FN_LISTA_DIMS())=4 
        THEN FALSE
    ELSE FALSE
END
;

