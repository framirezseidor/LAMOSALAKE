CREATE OR REPLACE PROCEDURE CON.SP_CON_DIM_MAT_MATERIAL()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS
$$
/*
---------------------------------------------------------------------------------
 Versión:            1.0
 Fecha de creación:  2025-04-28
 Creador:            Juan Diego Bonifacio
 Descripción:        SP que transforma datos desde la capa PRE a CON para DIM_MAT_MATERIAL
---------------------------------------------------------------------------------
*/

DECLARE
    -- VARIABLES DE CONTROL
    F_INICIO        TIMESTAMP_NTZ(9);
    F_FIN           TIMESTAMP_NTZ(9);
    T_EJECUCION     NUMBER(38,0);
    ROWS_INSERTED   NUMBER(38,0);
    TEXTO           VARCHAR(200);

BEGIN

    ---------------------------------------------------------------------------------
    -- STEP 1: LIMPIEZA DE DATOS EN LA TABLA CON
    ---------------------------------------------------------------------------------
    BEGIN
        SELECT CURRENT_TIMESTAMP() INTO :F_INICIO;

        DELETE FROM CON.DIM_MAT_MATERIAL;

        SELECT CURRENT_TIMESTAMP() INTO :F_FIN;
        SELECT DATEDIFF(millisecond, :F_INICIO, :F_FIN) INTO :T_EJECUCION;
    EXCEPTION
        WHEN statement_error THEN
            SELECT ('Error en DELETE: ' || :sqlerrm) INTO :TEXTO;
    END;

    ---------------------------------------------------------------------------------
    -- STEP 2: INSERCIÓN DE DATOS DESDE PRE HACIA CON
    ---------------------------------------------------------------------------------
    BEGIN
        SELECT CURRENT_TIMESTAMP() INTO :F_INICIO;

        INSERT INTO CON.DIM_MAT_MATERIAL
        (
            MATERIAL_ID,
            TIPOMATERIAL_ID,
            GRUPOARTICULOS_ID,
            STATUSMAT_TODOSCENTROS_ID,
            STATUSMAT_CANDIS_ID,
            GRUPOARTICULOSEXTERNO_ID,
            LABORATORIO_ID,
            UNI_UMB,
            COLOR_ADH_ID,
            COLORGRUPO_ADH_ID,
            LINEAMATERIAL_ADH_ID,
            MARCA_ADH_ID,
            MARCAGRUPO_ADH_ID,
            NIVELPRECIO_ADH_ID,
            ORIGENMATERIAL_ADH_ID,
            ORIGENPAIS_ADH_ID,
            PRESENTACION_ID,
            FAMILIA_ADH_ID,
            TIPOEMPAQUE_ID,
            ACABADO_ID,
            APLICACION_ID,
            DISENODETALLE_ID,
            CALIDAD_ID,
            LANZAMIENTOS_ID,
            COLOR_REV_ID,
            COLORGRUPO_REV_ID,
            CUERPO_ID,
            CUERPODET_ID,
            DISENO_ID,
            ESPESOR_ID,
            ESTATUSCATALOGO_ID,
            FAMILIA_REV_ID,
            FAMILIAGRUPO_ID,
            FORMATO_ID,
            FORMATOGRUPO_ID,
            FORMATORANGO_ID,
            FORMATOTAMANO_ID,
            LINEAMATERIAL_ID,
            MARCA_REV_ID,
            MARCAGRUPO_REV_ID,
            MARCAPLANEACION_ID,
            SEGMENTO_REV_ID,
            PEIDESTONALIZACION_ID,
            ORIGENMATERIAL_REV_ID,
            PADRE_ID,
            ORIGENPAIS_REV_ID,
            PROCESOADICIONAL_ID,
            ORIGENPROVEEDOR_ID,
            PUNZON_ID,
            PUNZONDETALLE_ID,
            RECTIFICADO_ID,
            RESERVADO_ID,
            SUBMARCA_ID,
            TECNOLOGIA_ID,
            TECNOLOGIAGRUPO_ID,
            MATERIAL_TEXT,
            SISORIGEN_ID,
            MANDANTE,
            FECHA_CARGA ,
            ZONA_HORARIA
        )
        SELECT
            -- Transformaciones desde PRE
            LTRIM(MATERIAL_ID,'0') MATERIAL_ID,
            TIPOMATERIAL_ID,
            GRUPOARTICULOS_ID,
            STATUSMAT_TODOSCENTROS_ID,
            STATUSMAT_CANDIS_ID,
            GRUPOARTICULOSEXTERNO_ID,
            LABORATORIO_ID,
            UNI_UMB,
            COLOR_ADH_ID,
            COLORGRUPO_ADH_ID,
            LINEAMATERIAL_ADH_ID,
            MARCA_ADH_ID,
            MARCAGRUPO_ADH_ID,
            NIVELPRECIO_ADH_ID,
            ORIGENMATERIAL_ADH_ID,
            ORIGENPAIS_ADH_ID,
            PRESENTACION_ID,
            FAMILIA_ADH_ID,
            TIPOEMPAQUE_ID,
            ACABADO_ID,
            APLICACION_ID,
            DISENODETALLE_ID,
            CALIDAD_ID,
            LANZAMIENTOS_ID,
            COLOR_REV_ID,
            COLORGRUPO_REV_ID,
            CUERPO_ID,
            CUERPODET_ID,
            DISENO_ID,
            ESPESOR_ID,
            ESTATUSCATALOGO_ID,
            FAMILIA_REV_ID,
            FAMILIAGRUPO_ID,
            FORMATO_ID,
            FORMATOGRUPO_ID,
            FORMATORANGO_ID,
            FORMATOTAMANO_ID,
            LINEAMATERIAL_ID,
            MARCA_REV_ID,
            MARCAGRUPO_REV_ID,
            MARCAPLANEACION_ID,
            SEGMENTO_REV_ID,
            PEIDESTONALIZACION_ID,
            ORIGENMATERIAL_REV_ID,
            PADRE_ID,
            ORIGENPAIS_REV_ID,
            PROCESOADICIONAL_ID,
            ORIGENPROVEEDOR_ID,
            PUNZON_ID,
            PUNZONDETALLE_ID,
            RECTIFICADO_ID,
            RESERVADO_ID,
            SUBMARCA_ID,
            TECNOLOGIA_ID,
            TECNOLOGIAGRUPO_ID,
            MATERIAL_TEXT,
            SISORIGEN_ID,
            MANDANTE,
            FECHA_CARGA ,
            ZONA_HORARIA
        FROM PRE.PDIM_MAT_MATERIAL;

        -- Conteo de filas insertadas
        SELECT COUNT(*) INTO :ROWS_INSERTED FROM CON.DIM_MAT_MATERIAL;

        SELECT CURRENT_TIMESTAMP() INTO :F_FIN;
        SELECT DATEDIFF(millisecond, :F_INICIO, :F_FIN) INTO :T_EJECUCION;
    EXCEPTION
        WHEN statement_error THEN
            SELECT ('Error en DELETE: ' || :sqlerrm) INTO :TEXTO;
    END;

    ---------------------------------------------------------------------------------
    -- STEP 3: LOG
    ---------------------------------------------------------------------------------
    SELECT COALESCE(:TEXTO, 'EJECUCION CORRECTA') INTO :TEXTO;

    INSERT INTO LOGS.HISTORIAL_EJECUCIONES
    VALUES ('SP_CON_DIM_MAT_MATERIAL','CON.DIM_MAT_MATERIAL', :F_INICIO, :F_FIN, :T_EJECUCION, :ROWS_INSERTED, :TEXTO );

    ---------------------------------------------------------------------------------
    -- STEP 4: MIRRORING
    ---------------------------------------------------------------------------------
    
    ---------------------------------------------
    -- ADH
    ---------------------------------------------

    DELETE FROM MIRRORING.DIM_MAT_MATERIAL_ADH;

    INSERT INTO MIRRORING.DIM_MAT_MATERIAL_ADH
    (
        MATERIAL_ID	,
        TIPOMATERIAL_ID	,
        GRUPOARTICULOS_ID	,
        STATUSMAT_TODOSCENTROS_ID	,
        GRUPOARTICULOSEXTERNO_ID,
        LABORATORIO_ID,
        UNI_UMB	,
        COLOR_ADH_ID	,
        COLORGRUPO_ADH_ID	,
        LINEAMATERIAL_ADH_ID	,
        SUBLINEAMATERIAL_ADH_ID	,
        MARCA_ADH_ID	,
        MARCAGRUPO_ADH_ID	,
        NIVELPRECIO_ADH_ID	,
        ORIGENMATERIAL_ADH_ID	,
        ORIGENPAIS_ADH_ID	,
        PRESENTACION_ID	,
        FAMILIA_ADH_ID	,
        TIPOEMPAQUE_ID	,
        MATERIAL_TEXT	,
        TIPOMATERIAL_TEXT	,
        GRUPOARTICULOS_TEXT	,
        STATUSMAT_TODOSCENTROS_TEXT	,
        GRUPOARTICULOSEXTERNO_TEXT,
        LABORATORIO_TEXT,
        UNI_UMB_TEXT	,
        COLOR_ADH_TEXT	,
        COLORGRUPO_ADH_TEXT	,
        LINEAMATERIAL_ADH_TEXT	,
        SUBLINEAMATERIAL_ADH_TEXT	,
        MARCA_ADH_TEXT	,
        MARCAGRUPO_ADH_TEXT	,
        NIVELPRECIO_ADH_TEXT	,
        ORIGENMATERIAL_ADH_TEXT	,
        ORIGENPAIS_ADH_TEXT	,
        PRESENTACION_TEXT	,
        FAMILIA_ADH_TEXT	,
        TIPOEMPAQUE_TEXT	,
        MATERIAL_ID_TEXT	,
        TIPOMATERIAL_ID_TEXT	,
        GRUPOARTICULOS_ID_TEXT	,
        STATUSMAT_TODOSCENTROS_ID_TEXT	,
        GRUPOARTICULOSEXTERNO_ID_TEXT,
        LABORATORIO_ID_TEXT,
        UNI_UMB_ID_TEXT	,
        COLOR_ADH_ID_TEXT	,
        COLORGRUPO_ADH_ID_TEXT	,
        LINEAMATERIAL_ADH_ID_TEXT	,
        SUBLINEAMATERIAL_ADH_ID_TEXT	,
        MARCA_ADH_ID_TEXT	,
        MARCAGRUPO_ADH_ID_TEXT	,
        NIVELPRECIO_ADH_ID_TEXT	,
        ORIGENMATERIAL_ADH_ID_TEXT	,
        ORIGENPAIS_ADH_ID_TEXT	,
        PRESENTACION_ID_TEXT	,
        FAMILIA_ADH_ID_TEXT	,
        TIPOEMPAQUE_ID_TEXT	,
        SISORIGEN_ID	,
        FECHA_CARGA	,
        ZONA_HORARIA	,
        MANDANTE	
    )
    SELECT
        LTRIM(M.MATERIAL_ID,'0') MATERIAL_ID	,
        M.TIPOMATERIAL_ID	,
        M.GRUPOARTICULOS_ID	,
        M.STATUSMAT_TODOSCENTROS_ID	,
        M.GRUPOARTICULOSEXTERNO_ID,
        M.LABORATORIO_ID,
        M.UNI_UMB	,
        M.COLOR_ADH_ID	,
        M.COLORGRUPO_ADH_ID	,
        M.LINEAMATERIAL_ADH_ID	,
        SL.A_SUBLINEA_M001 SUBLINEAMATERIAL_ADH_ID	,
        M.MARCA_ADH_ID	,
        M.MARCAGRUPO_ADH_ID	,
        M.NIVELPRECIO_ADH_ID	,
        M.ORIGENMATERIAL_ADH_ID	,
        M.ORIGENPAIS_ADH_ID	,
        M.PRESENTACION_ID	,
        M.FAMILIA_ADH_ID	,
        M.TIPOEMPAQUE_ID	,
        M.MATERIAL_TEXT	,
        TM.TIPOMATERIAL_TEXT	,
        GA.GRUPOARTICULOS_TEXT	,
        SM.STATUSMATERIAL_TEXT STATUSMAT_TODOSCENTROS_TEXT	,
        GAEXT.GRUPOARTICULOSEXTERNO_TEXT,
        LAB.LABORATORIO_TEXT,
        UNI.UNIDAD_TEXTO AS UNI_UMB_TEXT,
        CL.COLOR_ADH_TEXT ,
        CG.COLORGRUPO_ADH_TEXT	,
        LM.LINEAMATERIAL_TEXT	,
        FAMILIA_ADH_TEXT SUBLINEAMATERIAL_ADH_TEXT	,
        MAR.MARCA_ADH_TEXT	,
        MG.MARCAGRUPO_ADH_TEXT	,
        NP.NIVELPRECIO_ADH_TEXT	,
        OM.ORIGENMATERIAL_ADH_TEXT	,
        OP.ORIGENPAIS_ADH_TEXT	,
        PR.PRESENTACION_TEXT	,
        FM.FAMILIA_ADH_TEXT	,
        TE.TIPOEMPAQUE_TEXT	,
        CONCAT(LTRIM(M.MATERIAL_ID,'0'), ' - ', M.MATERIAL_TEXT) MATERIAL_ID_TEXT	,
        CONCAT(M.TIPOMATERIAL_ID, ' - ', TM.TIPOMATERIAL_TEXT) TIPOMATERIAL_ID_TEXT	,
        CONCAT(M.GRUPOARTICULOS_ID, ' - ', GA.GRUPOARTICULOS_TEXT) GRUPOARTICULOS_ID_TEXT	,
        CONCAT(M.STATUSMAT_TODOSCENTROS_ID	, ' - ', SM.STATUSMATERIAL_TEXT) STATUSMAT_TODOSCENTROS_ID_TEXT	,
        CONCAT(M.GRUPOARTICULOSEXTERNO_ID	, ' - ', GAEXT.GRUPOARTICULOSEXTERNO_TEXT ) GRUPOARTICULOSEXTERNO_ID_TEXT	,
        CONCAT(M.LABORATORIO_ID	, ' - ', LAB.LABORATORIO_TEXT) LABORATORIO_ID_TEXT,
        CONCAT(M.UNI_UMB, ' - ', UNI.UNIDAD_TEXTO ) AS UNI_UMB_ID_TEXT,
        CONCAT(COALESCE(M.COLOR_ADH_ID,'')          ,' - ', COALESCE(CL.COLOR_ADH_TEXT,'') ) COLOR_ADH_ID_TEXT ,
        CONCAT(COALESCE(M.COLORGRUPO_ADH_ID,'')     ,' - ', COALESCE(CG.COLORGRUPO_ADH_TEXT,'') ) COLORGRUPO_ADH_ID_TEXT	,
        CONCAT(COALESCE(M.LINEAMATERIAL_ADH_ID,'')  ,' - ', COALESCE(LM.LINEAMATERIAL_TEXT, '') )  LINEAMATERIAL_ADH_ID_TEXT	,
        CONCAT(COALESCE(SL.A_SUBLINEA_M001,'')      ,' - ', COALESCE(FAMILIA_ADH_TEXT,'') ) SUBLINEAMATERIAL_ADH_ID_TEXT,
        CONCAT(COALESCE(M.MARCA_ADH_ID,'')          ,' - ', COALESCE(MAR.MARCA_ADH_TEXT,'') ) MARCA_ADH_ID_TEXT	,
        CONCAT(COALESCE(M.MARCAGRUPO_ADH_ID,'')     ,' - ', COALESCE(MG.MARCAGRUPO_ADH_TEXT,'') ) MARCAGRUPO_ADH_ID_TEXT	,
        CONCAT(COALESCE(M.NIVELPRECIO_ADH_ID,'')    ,' - ', COALESCE(NP.NIVELPRECIO_ADH_TEXT,'') ) NIVELPRECIO_ADH_ID_TEXT	,
        CONCAT(COALESCE(M.ORIGENMATERIAL_ADH_ID,'') ,' - ', COALESCE(OM.ORIGENMATERIAL_ADH_TEXT,'') ) ORIGENMATERIAL_ADH_ID_TEXT	,
        CONCAT(COALESCE(M.ORIGENPAIS_ADH_ID,'')     ,' - ', COALESCE(OP.ORIGENPAIS_ADH_TEXT,'') ) ORIGENPAIS_ADH_ID_TEXT	,
        CONCAT(COALESCE(M.PRESENTACION_ID,'')       ,' - ', COALESCE(PR.PRESENTACION_TEXT,'') ) PRESENTACION_ID_TEXT	,
        CONCAT(COALESCE(M.FAMILIA_ADH_ID,'')        ,' - ', COALESCE(FM.FAMILIA_ADH_TEXT,'') ) FAMILIA_ADH_ID_TEXT	,
        CONCAT(COALESCE(M.TIPOEMPAQUE_ID,'')        ,' - ', COALESCE(TE.TIPOEMPAQUE_TEXT,'') ) TIPOEMPAQUE_ID_TEXT	, 
        M.SISORIGEN_ID	,
        M.FECHA_CARGA	,
        M.ZONA_HORARIA	,
        M.MANDANTE	
    FROM
        CON.DIM_MAT_MATERIAL M
        LEFT JOIN CON.DIM_MAT_TIPOMATERIAL TM
        ON M.TIPOMATERIAL_ID = TM.TIPOMATERIAL_ID
        LEFT JOIN CON.DIM_MAT_GRUPOARTICULOS GA
        ON M.GRUPOARTICULOS_ID = GA.GRUPOARTICULOS_ID
        LEFT JOIN CON.DIM_MAT_STATUSMATERIAL SM
        ON M.STATUSMAT_TODOSCENTROS_ID = SM.STATUSMATERIAL_ID
        LEFT JOIN CON.DIM_MAT_GRUPOARTICULOSEXTERNO GAEXT
        ON M.GRUPOARTICULOSEXTERNO_ID = GAEXT.GRUPOARTICULOSEXTERNO_ID
        LEFT JOIN CON.DIM_MAT_LABORATORIO LAB
        ON M.LABORATORIO_ID = LAB.LABORATORIO_ID
        LEFT JOIN CON.DIM_MAT_COLOR_ADH CL
        ON M.COLOR_ADH_ID = CL.COLOR_ADH_ID
        LEFT JOIN CON.DIM_MAT_COLORGRUPO_ADH CG
        ON M.COLORGRUPO_ADH_ID = CG.COLORGRUPO_ADH_ID
        LEFT JOIN CON.DIM_MAT_LINEAMATERIAL_ADH LM
        ON M.LINEAMATERIAL_ADH_ID = LM.LINEAMATERIAL_ID
        LEFT JOIN RAW.SQ1_EXT_1CL_OMAT001 SL
        ON M.MATERIAL_ID = SL.MATNR
    --    --LEFT JOIN CON.DIM_MAT_SUBLINEAMATERIAL_ADH SLM
    --    --ON SL.A_SUBLINEA_M001 = SLM.SUBLINEAMATERIAL_ID
        -- LEFT JOIN CON.DIM_MAT_RESERVADO_REV SLM
        -- ON SL.A_SUBLINEA_M001 = SLM.RESERVADO_ID          
        LEFT JOIN CON.DIM_MAT_MARCA_ADH MAR
        ON M.MARCA_ADH_ID = MAR.MARCA_ADH_ID
        LEFT JOIN CON.DIM_MAT_MARCAGRUPO_ADH MG
        ON M.MARCAGRUPO_ADH_ID = MG.MARCAGRUPO_ADH_ID
        LEFT JOIN CON.DIM_MAT_NIVELPRECIO_ADH NP
        ON M.NIVELPRECIO_ADH_ID = NP.NIVELPRECIO_ADH_ID
        LEFT JOIN CON.DIM_MAT_ORIGENMATERIAL_ADH OM
        ON M.ORIGENMATERIAL_ADH_ID = OM.ORIGENMATERIAL_ADH_ID
        LEFT JOIN CON.DIM_MAT_ORIGENPAIS_ADH OP
        ON M.ORIGENPAIS_ADH_ID = OP.ORIGENPAIS_ADH_ID
        LEFT JOIN CON.DIM_MAT_PRESENTACION_ADH PR
        ON M.PRESENTACION_ID = PR.PRESENTACION_ID
        LEFT JOIN CON.DIM_MAT_FAMILIA_ADH FM -- FAMILIA_ADH antes era SUBLINEAMATERIAL_ADH
        ON M.FAMILIA_ADH_ID = FM.FAMILIA_ADH_ID
        LEFT JOIN CON.DIM_MAT_TIPOEMPAQUE_ADH TE
        ON M.TIPOEMPAQUE_ID = TE.TIPOEMPAQUE_ID
        LEFT JOIN CON.DIM_UNI_UNIDADES UNI
        ON M.UNI_UMB = UNI.UNIDAD_ID
        ;
        
    ---------------------------------------------
    -- REV
    ---------------------------------------------
    DELETE FROM MIRRORING.DIM_MAT_MATERIAL_REV;

    INSERT INTO MIRRORING.DIM_MAT_MATERIAL_REV 
    (
        MATERIAL_ID,
        TIPOMATERIAL_ID,
        GRUPOARTICULOS_ID,
        STATUSMAT_TODOSCENTROS_ID,
        UNI_UMB,
        COLOR_REV_ID,
        COLORGRUPO_REV_ID,
        LINEAMATERIAL_REV_ID,
        MARCA_REV_ID,
        MARCAGRUPO_REV_ID,
        ORIGENMATERIAL_REV_ID,
        ORIGENPAIS_REV_ID,
        -- PRESENTACION_ID,
        FAMILIA_REV_ID,
        --TIPOEMPAQUE_ID,
        MATERIAL_TEXT,
        TIPOMATERIAL_TEXT,
        GRUPOARTICULOS_TEXT,
        STATUSMAT_TODOSCENTROS_TEXT,
        UNI_UMB_TEXT,
        COLOR_REV_TEXT,
        COLORGRUPO_REV_TEXT,
        LINEAMATERIAL_REV_TEXT,
        MARCA_REV_TEXT,
        MARCAGRUPO_REV_TEXT,
        ORIGENMATERIAL_REV_TEXT,
        ORIGENPAIS_REV_TEXT,
        -- PRESENTACION_TEXT,
        FAMILIA_REV_TEXT,
        MATERIAL_ID_TEXT,
        TIPOMATERIAL_ID_TEXT,
        GRUPOARTICULOS_ID_TEXT,
        STATUSMAT_TODOSCENTROS_ID_TEXT,
        UNI_UMB_ID_TEXT,
        COLOR_REV_ID_TEXT,
        COLORGRUPO_REV_ID_TEXT,
        LINEAMATERIAL_REV_ID_TEXT,
        MARCA_REV_ID_TEXT,
        MARCAGRUPO_REV_ID_TEXT,
        ORIGENMATERIAL_REV_ID_TEXT,
        ORIGENPAIS_REV_ID_TEXT,
        FAMILIA_REV_ID_TEXT,
        SISORIGEN_ID,
        FECHA_CARGA,
        ZONA_HORARIA,
        MANDANTE
    )
    SELECT 
        LTRIM(M.MATERIAL_ID, '0') AS MATERIAL_ID,
        M.TIPOMATERIAL_ID AS TIPOMATERIAL_ID,
        M.GRUPOARTICULOS_ID AS GRUPOARTICULOS_ID ,
        M.STATUSMAT_TODOSCENTROS_ID AS STATUSMAT_TODOSCENTROS_ID,
        M.UNI_UMB AS UNI_UMB,
        M.COLOR_REV_ID AS COLOR_REV_ID,
        M.COLORGRUPO_REV_ID AS COLORGRUPO_REV_ID,
        M.LINEAMATERIAL_ID AS LINEAMATERIAL_REV_ID,
        M.MARCA_REV_ID AS MARCA_REV_ID,
        M.MARCAGRUPO_REV_ID AS MARCAGRUPO_REV_ID,
        M.ORIGENMATERIAL_REV_ID AS ORIGENMATERIAL_REV_ID,
        M.ORIGENPAIS_REV_ID AS ORIGENPAIS_REV_ID,
        --M.PRESENTACION_ID, 
        M.FAMILIA_REV_ID AS FAMILIA_REV_ID, 
        --M.TIPOEMPAQUE_ID, 
        M.MATERIAL_TEXT AS MATERIAL_TEXT, 
        TM.TIPOMATERIAL_TEXT AS TIPOMATERIAL_TEXT,
        GA.GRUPOARTICULOS_TEXT AS GRUPOARTICULOS_TEXT,
        SM.STATUSMATERIAL_TEXT AS STATUSMAT_TODOSCENTROS_TEXT,
        UNI.UNIDAD_TEXTO AS UNI_UMB_TEXT,
        CL.COLOR_REV_TEXT AS COLOR_REV_TEXT,
        CG.COLORGRUPO_REV_TEXT AS COLORGRUPO_REV_TEXT,
        LM.LINEAMATERIAL_TEXT AS LINEAMATERIAL_TEXT,
        MAR.MARCA_REV_TEXT AS MARCA_REV_TEXT,
        MG.MARCAGRUPO_REV_TEXT AS MARCAGRUPO_REV_TEXT,
        OM.ORIGENMATERIAL_REV_TEXT AS ORIGENMATERIAL_REV_TEXT,
        OP.ORIGENPAIS_REV_TEXT AS ORIGENPAIS_REV_TEXT,
        FM.FAMILIA_REV_TEXT AS FAMILIA_REV_TEXT,

        CONCAT(LTRIM(M.MATERIAL_ID,'0'),' - ',M.MATERIAL_TEXT) AS MATERIAL_ID_TEXT,
        CONCAT(M.TIPOMATERIAL_ID,' - ',TM.TIPOMATERIAL_TEXT) AS TIPOMATERIAL_ID_TEXT,
        CONCAT(M.GRUPOARTICULOS_ID,' - ',GA.GRUPOARTICULOS_TEXT) AS GRUPOARTICULOS_ID_TEXT,
        CONCAT(M.STATUSMAT_TODOSCENTROS_ID,' - ',SM.STATUSMATERIAL_TEXT) AS STATUSMAT_TODOSCENTROS_ID_TEXT,
        CONCAT(M.UNI_UMB,' - ',UNI.UNIDAD_TEXTO) AS UNI_UMB_ID_TEXT,
        CONCAT(COALESCE(M.COLOR_REV_ID,'')          ,' - ', COALESCE(CL.COLOR_REV_TEXT,'') ) AS COLOR_REV_ID_TEXT,
        CONCAT(COALESCE(M.COLORGRUPO_REV_ID,'')     ,' - ', COALESCE(CG.COLORGRUPO_REV_TEXT,'') ) AS COLORGRUPO_REV_ID_TEXT,
        CONCAT(COALESCE(M.LINEAMATERIAL_ID,'')      ,' - ', COALESCE(LM.LINEAMATERIAL_TEXT,'') ) AS LINEAMATERIAL_REV_ID_TEXT,
        CONCAT(COALESCE(M.MARCA_REV_ID,'')          ,' - ', COALESCE(MAR.MARCA_REV_TEXT,'') ) AS MARCA_REV_ID_TEXT,
        CONCAT(COALESCE(M.MARCAGRUPO_REV_ID,'')     ,' - ', COALESCE(MG.MARCAGRUPO_REV_TEXT,'') ) AS MARCAGRUPO_REV_ID_TEXT,
        CONCAT(COALESCE(M.ORIGENMATERIAL_REV_ID,'') ,' - ', COALESCE(OM.ORIGENMATERIAL_REV_TEXT,'') ) AS ORIGENMATERIAL_REV_ID_TEXT,
        CONCAT(COALESCE(M.ORIGENPAIS_REV_ID,'')     ,' - ', COALESCE(OP.ORIGENPAIS_REV_TEXT,'') ) AS ORIGENPAIS_REV_ID_TEXT,
        CONCAT(COALESCE(M.FAMILIA_REV_ID,'')        ,' - ', COALESCE(FM.FAMILIA_REV_TEXT,'') ) AS FAMILIA_REV_ID_TEXT,
        
        M.SISORIGEN_ID	,
        M.FECHA_CARGA	,
        M.ZONA_HORARIA	,
        M.MANDANTE
    FROM CON.DIM_MAT_MATERIAL M
        LEFT JOIN CON.DIM_MAT_TIPOMATERIAL TM
            ON M.TIPOMATERIAL_ID = TM.TIPOMATERIAL_ID
        LEFT JOIN CON.DIM_MAT_GRUPOARTICULOS GA
            ON M.GRUPOARTICULOS_ID = GA.GRUPOARTICULOS_ID
        LEFT JOIN CON.DIM_MAT_STATUSMATERIAL SM
            ON M.STATUSMAT_TODOSCENTROS_ID = SM.STATUSMATERIAL_ID
        LEFT JOIN CON.DIM_UNI_UNIDADES UNI
            ON M.UNI_UMB = UNI.UNIDAD_ID
        LEFT JOIN CON.DIM_MAT_COLOR_REV CL
            ON M.COLOR_REV_ID = CL.COLOR_REV_ID
        LEFT JOIN CON.DIM_MAT_COLORGRUPO_REV CG
            ON M.COLORGRUPO_REV_ID = CG.COLORGRUPO_REV_ID
        LEFT JOIN CON.DIM_MAT_LINEAMATERIAL_REV LM 
            ON M.LINEAMATERIAL_ID = LM.LINEAMATERIAL_ID 
        LEFT JOIN CON.DIM_MAT_MARCA_REV MAR
            ON M.MARCA_REV_ID = MAR.MARCA_REV_ID
        LEFT JOIN CON.DIM_MAT_MARCAGRUPO_REV MG 
            ON M.MARCAGRUPO_REV_ID = MG.MARCAGRUPO_REV_ID
        LEFT JOIN CON.DIM_MAT_ORIGENMATERIAL_REV OM
            ON M.ORIGENMATERIAL_REV_ID = OM.ORIGENMATERIAL_REV_ID
        LEFT JOIN CON.DIM_MAT_ORIGENPAIS_REV OP
            ON M.ORIGENPAIS_REV_ID = OP.ORIGENPAIS_REV_ID 
        LEFT JOIN CON.DIM_MAT_FAMILIA_REV FM
            ON M.FAMILIA_REV_ID = FM.FAMILIA_REV_ID
    ;

------------------------------------------------------------------------------
----INSERCION DE DATOS MAESTROS HISTÓRICOS ADHESIVOS 08/09/2025
------------------------------------------------------------------------------
    INSERT INTO MIRRORING.DIM_MAT_MATERIAL_ADH
    (
        MATERIAL_ID	,
        TIPOMATERIAL_ID	,
        GRUPOARTICULOS_ID	,
        STATUSMAT_TODOSCENTROS_ID	,
        GRUPOARTICULOSEXTERNO_ID,
        LABORATORIO_ID,
        UNI_UMB	,
        COLOR_ADH_ID	,
        COLORGRUPO_ADH_ID	,
        LINEAMATERIAL_ADH_ID	,
        SUBLINEAMATERIAL_ADH_ID	,
        MARCA_ADH_ID	,
        MARCAGRUPO_ADH_ID	,
        NIVELPRECIO_ADH_ID	,
        ORIGENMATERIAL_ADH_ID	,
        ORIGENPAIS_ADH_ID	,
        PRESENTACION_ID	,
        FAMILIA_ADH_ID	,
        TIPOEMPAQUE_ID	,
        MATERIAL_TEXT	,
        TIPOMATERIAL_TEXT	,
        GRUPOARTICULOS_TEXT	,
        STATUSMAT_TODOSCENTROS_TEXT	,
        UNI_UMB_TEXT	,
        COLOR_ADH_TEXT	,
        COLORGRUPO_ADH_TEXT	,
        LINEAMATERIAL_ADH_TEXT	,
        SUBLINEAMATERIAL_ADH_TEXT	,
        MARCA_ADH_TEXT	,
        MARCAGRUPO_ADH_TEXT	,
        NIVELPRECIO_ADH_TEXT	,
        ORIGENMATERIAL_ADH_TEXT	,
        ORIGENPAIS_ADH_TEXT	,
        PRESENTACION_TEXT	,
        FAMILIA_ADH_TEXT	,
        TIPOEMPAQUE_TEXT	,
        MATERIAL_ID_TEXT	,
        TIPOMATERIAL_ID_TEXT	,
        GRUPOARTICULOS_ID_TEXT	,
        STATUSMAT_TODOSCENTROS_ID_TEXT	,
        UNI_UMB_ID_TEXT	,
        COLOR_ADH_ID_TEXT	,
        COLORGRUPO_ADH_ID_TEXT	,
        LINEAMATERIAL_ADH_ID_TEXT	,
        SUBLINEAMATERIAL_ADH_ID_TEXT	,
        MARCA_ADH_ID_TEXT	,
        MARCAGRUPO_ADH_ID_TEXT	,
        NIVELPRECIO_ADH_ID_TEXT	,
        ORIGENMATERIAL_ADH_ID_TEXT	,
        ORIGENPAIS_ADH_ID_TEXT	,
        PRESENTACION_ID_TEXT	,
        FAMILIA_ADH_ID_TEXT	,
        TIPOEMPAQUE_ID_TEXT	,
        SISORIGEN_ID	,
        FECHA_CARGA	,
        ZONA_HORARIA	,
        MANDANTE	
    )
        SELECT
            MATERIAL_ID,
            COALESCE(TIPOMATERIAL_ID,'') AS TIPOMATERIAL_ID,
            COALESCE(GRUPOARTICULOS_ID,'') AS GRUPOARTICULOS_ID,
            COALESCE(STATUSMAT_TODOSCENTROS_ID,'') AS STATUSMAT_TODOSCENTROS_ID,
            '' AS GRUPOARTICULOSEXTERNO_ID,
            '' AS LABORATORIO_ID,
            COALESCE(UNI_UMB,'') AS UNI_UMB,
            COALESCE(COLOR_ADH_ID,'') AS COLOR_ADH_ID,
            COALESCE(COLORGRUPO_ADH_ID,'') AS COLORGRUPO_ADH_ID,
            COALESCE(LINEAMATERIAL_ADH_ID,'') AS LINEAMATERIAL_ADH_ID,
            COALESCE(SUBLINEAMATERIAL_ADH_ID,'') AS SUBLINEAMATERIAL_ADH_ID,
            COALESCE(MARCA_ADH_ID,'') AS MARCA_ADH_ID,
            COALESCE(MARCAGRUPO_ADH_ID,'') AS MARCAGRUPO_ADH_ID,
            COALESCE(NIVELPRECIO_ADH_ID,'') AS NIVELPRECIO_ADH_ID,
            COALESCE(ORIGENMATERIAL_ADH_ID,'') AS ORIGENMATERIAL_ADH_ID,
            COALESCE(ORIGENPAIS_ADH_ID,'') AS ORIGENPAIS_ADH_ID,
            COALESCE(PRESENTACION_ID,'') AS PRESENTACION_ID,
            COALESCE(FAMILIA_ADH_ID,'') AS FAMILIA_ADH_ID,
            COALESCE(TIPOEMPAQUE_ID,'') AS TIPOEMPAQUE_ID,
            COALESCE(MATERIAL_TEXT,'') AS MATERIAL_TEXT,
            COALESCE(TIPOMATERIAL_TEXT,'') AS TIPOMATERIAL_TEXT,
            COALESCE(GRUPOARTICULOS_TEXT,'') AS GRUPOARTICULOS_TEXT,
            COALESCE(STATUSMAT_TODOSCENTROS_TEXT,'') AS STATUSMAT_TODOSCENTROS_TEXT,
            COALESCE(UNI_UMB_TEXT,'') AS UNI_UMB_TEXT,
            COALESCE(COLOR_ADH_TEXT,'') AS COLOR_ADH_TEXT,
            COALESCE(COLORGRUPO_ADH_TEXT,'') AS COLORGRUPO_ADH_TEXT,
            COALESCE(LINEAMATERIAL_ADH_TEXT,'') AS LINEAMATERIAL_ADH_TEXT,
            COALESCE(SUBLINEAMATERIAL_ADH_TEXT,'') AS SUBLINEAMATERIAL_ADH_TEXT,
            COALESCE(MARCA_ADH_TEXT,'') AS MARCA_ADH_TEXT,
            COALESCE(MARCAGRUPO_ADH_TEXT,'') AS MARCAGRUPO_ADH_TEXT,
            COALESCE(NIVELPRECIO_ADH_TEXT,'') AS NIVELPRECIO_ADH_TEXT,
            COALESCE(ORIGENMATERIAL_ADH_TEXT,'') AS ORIGENMATERIAL_ADH_TEXT,
            COALESCE(ORIGENPAIS_ADH_TEXT,'') AS ORIGENPAIS_ADH_TEXT,
            COALESCE(PRESENTACION_TEXT,'') AS PRESENTACION_TEXT,
            COALESCE(FAMILIA_ADH_TEXT,'') AS FAMILIA_ADH_TEXT,
            COALESCE(TIPOEMPAQUE_TEXT,'') AS TIPOEMPAQUE_TEXT,
            COALESCE(MATERIAL_ID_TEXT,'') AS MATERIAL_ID_TEXT,
            COALESCE(TIPOMATERIAL_ID_TEXT,'') AS TIPOMATERIAL_ID_TEXT,
            COALESCE(GRUPOARTICULOS_ID_TEXT,'') AS GRUPOARTICULOS_ID_TEXT,
            COALESCE(STATUSMAT_TODOSCENTROS_ID_TEXT,'') AS STATUSMAT_TODOSCENTROS_ID_TEXT,
            COALESCE(UNI_UMB_ID_TEXT,'') AS UNI_UMB_ID_TEXT,
            COALESCE(COLOR_ADH_ID_TEXT,'') AS COLOR_ADH_ID_TEXT,
            COALESCE(COLORGRUPO_ADH_ID_TEXT,'') AS COLORGRUPO_ADH_ID_TEXT,
            COALESCE(LINEAMATERIAL_ADH_ID_TEXT,'') AS LINEAMATERIAL_ADH_ID_TEXT,
            COALESCE(SUBLINEAMATERIAL_ADH_ID_TEXT,'') AS SUBLINEAMATERIAL_ADH_ID_TEXT,
            COALESCE(MARCA_ADH_ID_TEXT,'') AS MARCA_ADH_ID_TEXT,
            COALESCE(MARCAGRUPO_ADH_ID_TEXT,'') AS MARCAGRUPO_ADH_ID_TEXT,
            COALESCE(NIVELPRECIO_ADH_ID_TEXT,'') AS NIVELPRECIO_ADH_ID_TEXT,
            COALESCE(ORIGENMATERIAL_ADH_ID_TEXT,'') AS ORIGENMATERIAL_ADH_ID_TEXT,
            COALESCE(ORIGENPAIS_ADH_ID_TEXT,'') AS ORIGENPAIS_ADH_ID_TEXT,
            COALESCE(PRESENTACION_ID_TEXT,'') AS PRESENTACION_ID_TEXT,
            COALESCE(FAMILIA_ADH_ID_TEXT,'') AS FAMILIA_ADH_ID_TEXT,
            COALESCE(TIPOEMPAQUE_ID_TEXT,'') AS TIPOEMPAQUE_ID_TEXT,
            SISORIGEN_ID,
            CURRENT_TIMESTAMP() AS FECHA_CARGA,
            RIGHT(CURRENT_TIMESTAMP(),5) AS  ZONA_HORARIA,
            MANDANTE
        FROM
            RAW.FILE_XLS_DIM_MAT_MATERIAL_ADH_DMH
        WHERE
            MATERIAL_ID NOT IN (SELECT DISTINCT MATERIAL_ID FROM MIRRORING.DIM_MAT_MATERIAL_ADH)
            ;            




    ---------------------------------------------------------------------------------
    -- STEP 5: CLONADO PARA PRODUCCIÓN DIM_MAT_ADH_PP. Se necesita para producir

    ---------------------------------------------------------------------------------

    CREATE OR REPLACE TABLE MIRRORING.DIM_MAT_ADH_PP CLONE MIRRORING.DIM_MAT_MATERIAL_ADH;
    create or replace stream LAMOSALAKE_DEV.MIRRORING.STREAM_DIM_MAT_ADH_PP ON table  MIRRORING.DIM_MAT_ADH_PP;
    ---------------------------------------------------------------------------------
    -- STEP 6: FINALIZACIÓN

    ---------------------------------------------------------------------------------
    RETURN CONCAT('Complete - Filas insertadas: ', ROWS_INSERTED);

END;
$$;
 
