name: Lamosa lake deploy

on:
  pull_request:
    types:
      - closed
    branches:
      - main
 
jobs:
  deploy_if_merged:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    env:
      ORIGIN_PREFIX: "SQ1_"
      PROD_PREFIX: "SP1_"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4


#      - name: Install snowcli
#        run: |
#          pip install snowflake-cli-labs      

      - name: Instalar snowsql
        run: |
          curl -L -o snowsql-linux_x86_64.bash https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/snowsql-linux_x86_64.bash
          bash snowsql-linux_x86_64.bash
          export PATH=$PATH:$HOME/.snowsql              
     
#      - name: Check Version and Verify Connection
#        run: |
#              snow --version
#              snow connection test
#              echo "Using branch $GITHUB_REF_NAME"



              
      - name: Reemplazar prefijo para producción
        run: |
          echo "Reemplazando prefijo en los archivos SQL"
          find . -type f -iname '*.sql' -print0 | xargs -0 -r sed -i -E "s/\b${ORIGIN_PREFIX}/${PROD_PREFIX}/g"
          echo "Estoy en: $(pwd)"
          echo "Cantidad de .sql encontrados: $(find . -type f -iname '*.sql' | wc -l)"


      - name: Crear conexión y ejecutar script
        env:
          SNOWFLAKE_ACCOUNT:   ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER:      ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD:  ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE:      ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE:  ${{ secrets.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA:    ${{ secrets.SNOWFLAKE_SCHEMA }}
        run: |
          snow sql \
            --account "$SNOWFLAKE_ACCOUNT" \
            --user "$SNOWFLAKE_USER" \
            --password "$SNOWFLAKE_PASSWORD" \
            --role "$SNOWFLAKE_ROLE" \
            --warehouse "$SNOWFLAKE_WAREHOUSE" \
            --database "$SNOWFLAKE_DATABASE" \
            --schema "$SNOWFLAKE_SCHEMA" \
            -f "./COMERCIAL/FCT_COM_REV_VENTAS.sql"

