name: Lamosa lake deploy

on:
  pull_request:
    types:
      - closed
    branches:
      - main
 
jobs:
  deploy_if_merged:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    env:
      ORIGIN_PREFIX: "SQ1_"
      PROD_PREFIX: "SP1_"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4


      - name: Install snowcli
        run: |
          pip install snowflake-cli-labs          
     
#      - name: Check Version and Verify Connection
#        run: |
#              snow --version
#              snow connection test
#              echo "Using branch $GITHUB_REF_NAME"



              
      - name: Reemplazar prefijo para producción
        run: |
          echo "Reemplazando prefijo en los archivos SQL"
          find . -type f -iname '*.sql' -print0 | xargs -0 -r sed -i -E "s/\b${ORIGIN_PREFIX}/${PROD_PREFIX}/g"
          echo "Estoy en: $(pwd)"
          echo "Cantidad de .sql encontrados: $(find . -type f -iname '*.sql' | wc -l)"


      - name: Ejecutar script Snowflake con conexión explícita
        run: |
          snow connection add -n "github_ci" \
            --account ${{ secrets.SNOWFLAKE_ACCOUNT }} \
            --user ${{ secrets.SNOWFLAKE_USER }} \
            --password ${{ secrets.SNOWFLAKE_PASSWORD }} \
            --role ${{ secrets.SNOWFLAKE_ROLE }} \
            --warehouse ${{ secrets.SNOWFLAKE_WAREHOUSE }} \
            --database ${{ secrets.SNOWFLAKE_DATABASE }} \
            --schema ${{ secrets.SNOWFLAKE_SCHEMA }}
            --default

          snow sql -f "./COMERCIAL/FCT_COM_REV_VENTAS.sql"


      - name: Buscar el archivo SQL
        run: |
          find . -iname "FCT_COM_REV_VENTAS.SQL"          


         

      
       

        
        