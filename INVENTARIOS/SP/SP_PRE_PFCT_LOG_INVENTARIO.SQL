CREATE OR REPLACE PROCEDURE PRE.SP_PRE_PFCT_LOG_INVENTARIO()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS
$$
/*
---------------------------------------------------------------------------------
 Versión:            1.0
 Fecha de creación:  2025-04-03
 Creador:            Carlos Panta
 Descripción:        SP que transforma datos desde la capa RAW a PRE para PFCT_LOG_INVENTARIO
---------------------------------------------------------------------------------
*/
DECLARE
    -- VARIABLES DE CONTROL
    F_INICIO        TIMESTAMP_NTZ(9);
    F_FIN           TIMESTAMP_NTZ(9);
    T_EJECUCION     NUMBER(38,0);
    ROWS_INSERTED   NUMBER(38,0);

BEGIN

    ---------------------------------------------------------------------------------
    -- STEP 1: LIMPIEZA DE DATOS EN LA TABLA PRE
    ---------------------------------------------------------------------------------
    BEGIN
        SELECT CURRENT_TIMESTAMP() INTO :F_INICIO;

        DELETE FROM PRE.PFCT_LOG_INVENTARIO;

        SELECT CURRENT_TIMESTAMP() INTO :F_FIN;
        SELECT DATEDIFF(millisecond, :F_INICIO, :F_FIN) INTO :T_EJECUCION;
    EXCEPTION
        WHEN statement_error THEN
            RETURN 'Error en DELETE: ' || :sqlerrm;
    END;

    ---------------------------------------------------------------------------------
    -- STEP 2: INSERCIÓN DE DATOS DESDE RAW HACIA PRE
    ---------------------------------------------------------------------------------
    BEGIN
        SELECT CURRENT_TIMESTAMP() INTO :F_INICIO;

        INSERT INTO PRE.PFCT_LOG_INVENTARIO
        (
            ANIO,
            MES, 
            ANIOMES, 
            FECHA_FOTO_INVENTARIO, 
            CENTRO_ID, 
            ALMACEN_ID, 
            ALMACENCENTRO_ID, 
            MATERIAL_ID, 
            MATERIALCENTRO_ID, 
            TIPOMATERIAL_ID, 
            CONTROL_PRECIOS, 
            STOCKESPECIAL, 
            NUMSTOCKESPECIAL, 
            LOTE, 
            LOTECENTRO_ID, 
            IND_LIBRE_UTILIZACION_UMB, 
            IND_BLOQUEADO_UMB, 
            IND_CONTROL_CALIDAD_UMB, 
            IND_TRANSITO_UMB, 
            IND_INVENTARIO_FISICO_UMB, 
            IND_LIBRE_VENTA_UMB, 
            IND_STOCK_SEGURIDAD_UMB, 
            UNI_UMB, 
            IND_LIBRE_UTILIZACION_EST, 
            IND_BLOQUEADO_EST, 
            IND_CONTROL_CALIDAD_EST, 
            IND_TRANSITO_EST, 
            IND_INVENTARIO_FISICO_EST, 
            IND_LIBRE_VENTA_EST, 
            IND_STOCK_SEGURIDAD_EST, 
            UNI_EST, 
            IND_COSTO_INV_MXN, 
            MON_MXN, 
            IND_COSTO_INV_LOC, 
            MON_LOC, 
            IND_COSTO_INV_USD, 
            MON_USD, 
            SISORIGEN_ID, 
            MANDANTE, 
            FECHA_CARGA, 
            ZONA_HORARIA 
        )
       SELECT
            IFNULL(SUBSTR(Z.FECHA,1,4),''),-- ANIO,
            IFNULL(SUBSTR(Z.FECHA,6,2),''),-- MES, 
            IFNULL(CONCAT(SUBSTR(Z.FECHA,1,4),SUBSTR(Z.FECHA,6,2)),''),-- ANIOMES, 
            IFNULL(replace(to_varchar(FECHA),'-',''),''),-- FECHA_FOTO_INVENTARIO, 
            IFNULL(PLANT,''),-- CENTRO_ID, 
            IFNULL(STORAGELOCATION,''),-- ALMACEN_ID, 
            IFNULL(CONCAT(Z.PLANT,'_',Z.STORAGELOCATION),''),-- ALMACENCENTRO_ID, 
            IFNULL(MATERIAL,''),-- MATERIAL_ID, 
            IFNULL(CONCAT(PLANT,'_',MATERIAL),''),-- MATERIALCENTRO_ID, 
            IFNULL(MATERIALTYPE,''),-- TIPOMATERIAL_ID, 
            IFNULL(PRICE_CTRL_MSOCIEDAD,''),-- CONTROL_PRECIOS, 
            IFNULL(INVENTORYSPECIALSTOCKTYPE,''),-- STOCKESPECIAL, 
            IFNULL(SPECIALSTOCKIDFGCUSTOMER,''),-- NUMSTOCKESPECIAL, 
            IFNULL(STOCKIDENTIFYINGBATCH,''),-- LOTE, 
            IFNULL('',''),-- LOTECENTRO_ID, 
            IFNULL(SUM(CASE WHEN INVENTORYSTOCKTYPE = 01 THEN MATLWRHSSTKQTYINMATLBASEUNIT ELSE 0 END),0) AS IND_LIBRE_UTILIZACION_UMB,-- IND_LIBRE_UTILIZACION_UMB, 
            IFNULL(SUM(CASE WHEN INVENTORYSTOCKTYPE = 07 THEN MATLWRHSSTKQTYINMATLBASEUNIT ELSE 0 END),0) AS IND_BLOQUEADO_UMB,-- IND_BLOQUEADO_UMB, 
            IFNULL(SUM(CASE WHEN INVENTORYSTOCKTYPE = 02 THEN MATLWRHSSTKQTYINMATLBASEUNIT ELSE 0 END),0) AS IND_CONTROL_CALIDAD_UMB,-- IND_CONTROL_CALIDAD_UMB, 
            IFNULL(SUM(CASE WHEN INVENTORYSTOCKTYPE IN (04,05)  THEN MATLWRHSSTKQTYINMATLBASEUNIT ELSE 0 END),0) AS IND_TRANSITO_UMB,-- IND_TRANSITO_UMB, 
            IFNULL(SUM(CASE WHEN INVENTORYSTOCKTYPE = 01 THEN MATLWRHSSTKQTYINMATLBASEUNIT ELSE 0 END+
            CASE WHEN INVENTORYSTOCKTYPE = 07 THEN MATLWRHSSTKQTYINMATLBASEUNIT ELSE 0 END+
            CASE WHEN INVENTORYSTOCKTYPE = 02 THEN MATLWRHSSTKQTYINMATLBASEUNIT ELSE 0 END+ 
            CASE WHEN INVENTORYSTOCKTYPE IN (04,05)  THEN MATLWRHSSTKQTYINMATLBASEUNIT ELSE 0 END),0) AS IND_INVENTARIO_FISICO_UMB,-- IND_INVENTARIO_FISICO_UMB, 
            IFNULL(SUM(COM_QTY),0),-- IND_LIBRE_VENTA_UMB, 
            IFNULL(SUM(ZZEISBE),0),-- IND_STOCK_SEGURIDAD_UMB, 
            IFNULL(MATERIALBASEUNIT,''),-- UNI_UMB, 
            IFNULL(SUM(CASE WHEN INVENTORYSTOCKTYPE = 01 THEN MATLWRHSSTKQTYINMATLBASEUNIT * (UMREN/UMREZ) ELSE 0 END),0) AS IND_LIBRE_UTILIZACION_EST,-- IND_LIBRE_UTILIZACION_EST, 
            IFNULL(SUM(CASE WHEN INVENTORYSTOCKTYPE = 07 THEN MATLWRHSSTKQTYINMATLBASEUNIT * (UMREN/UMREZ)  ELSE 0 END),0) AS IND_BLOQUEADO_EST,-- IND_BLOQUEADO_EST, 
            IFNULL(SUM(CASE WHEN INVENTORYSTOCKTYPE = 02 THEN MATLWRHSSTKQTYINMATLBASEUNIT * (UMREN/UMREZ) ELSE 0 END),0) AS IND_CONTROL_CALIDAD_EST,-- IND_CONTROL_CALIDAD_EST, 
            IFNULL(SUM(CASE WHEN INVENTORYSTOCKTYPE IN (04,05) THEN MATLWRHSSTKQTYINMATLBASEUNIT * (UMREN/UMREZ)  ELSE 0 END),0) AS IND_TRANSITO_EST,-- IND_TRANSITO_EST, 
            IFNULL(SUM(CASE WHEN INVENTORYSTOCKTYPE = 01 THEN MATLWRHSSTKQTYINMATLBASEUNIT * (UMREN/UMREZ) ELSE 0 END+
            CASE WHEN INVENTORYSTOCKTYPE = 07 THEN MATLWRHSSTKQTYINMATLBASEUNIT * (UMREN/UMREZ)  ELSE 0 END +
            CASE WHEN INVENTORYSTOCKTYPE = 02 THEN MATLWRHSSTKQTYINMATLBASEUNIT * (UMREN/UMREZ) ELSE 0 END+
            CASE WHEN INVENTORYSTOCKTYPE IN (04,05) THEN MATLWRHSSTKQTYINMATLBASEUNIT * (UMREN/UMREZ)  ELSE 0 END),0) AS IND_INVENTARIO_FISICO_EST,-- IND_INVENTARIO_FISICO_EST, 
            IFNULL(SUM(COM_QTY * (UMREN/UMREZ)),0),-- IND_LIBRE_VENTA_EST, 
            IFNULL(SUM(ZZEISBE * (UMREN/UMREZ)),0),-- IND_STOCK_SEGURIDAD_EST, 
            IFNULL(CASE WHEN PLANT LIKE 'R%' THEN 'M2' WHEN PLANT LIKE 'A%' THEN 'TON' END,''),-- UNI_EST, 
            IFNULL(SUM(CASE WHEN PRICE_BASE_MGRUPO=0 THEN 0 ELSE (MATLWRHSSTKQTYINMATLBASEUNIT*MATPRICE_MGRUPO)/PRICE_BASE_MGRUPO END),0),-- IND_COSTO_INV_MXN, 
            IFNULL(CURRENCY_MGRUPO,''),-- MON_MXN, 
            IFNULL(SUM(CASE WHEN PRICE_BASE_MSOCIEDAD=0 THEN 0 ELSE (MATLWRHSSTKQTYINMATLBASEUNIT*MATPRICE_MSOCIEDAD)/PRICE_BASE_MSOCIEDAD END),0),-- IND_COSTO_INV_LOC, 
            IFNULL(CURRENCY_MSOCIEDAD,''),-- MON_LOC, 
            IFNULL(SUM(CASE WHEN PRICE_BASE_MFUERTE=0 THEN 0 ELSE (MATLWRHSSTKQTYINMATLBASEUNIT*MATPRICE_MFUERTE)/PRICE_BASE_MFUERTE END),0),-- IND_COSTO_INV_USD, 
            IFNULL(CURRENCY_MFUERTE,''),-- MON_USD, 
            Z.SISORIGEN_ID,-- SISORIGEN_ID, 
            Z.MANDANTE,-- MANDANTE, 
            CURRENT_TIMESTAMP,-- FECHA_CARGA, 
            RIGHT(CURRENT_TIMESTAMP,5),-- ZONA_HORARIA  
        FROM RAW.SQ1_MOF_ZMM_INVENTARIO Z
        LEFT JOIN RAW.SQ1_EXT_0MAT_UNIT_ATTR UNIT ON Z.MATERIAL=UNIT.MATNR
        LEFT JOIN RAW.SQ1_EXT_0MAT_PLANT_ATTR PLANT ON Z.MATERIAL=PLANT.MATNR AND Z.PLANT=PLANT.WERKS
        WHERE VALUATIONAREATYPE=1
        GROUP BY
        SUBSTR(Z.FECHA,1,4),-- ANIO,
        SUBSTR(Z.FECHA,6,2),-- MES, 
        CONCAT(SUBSTR(Z.FECHA,1,4),SUBSTR(Z.FECHA,6,2)),-- ANIOMES, 
        FECHA,-- FECHA_FOTO_INVENTARIO, 
        PLANT,-- CENTRO_ID, 
        STORAGELOCATION,-- ALMACEN_ID, 
        CONCAT(Z.PLANT,'_',Z.STORAGELOCATION),-- ALMACENCENTRO_ID, 
        MATERIAL,-- MATERIAL_ID, 
        CONCAT(PLANT,'_',MATERIAL),-- MATERIALCENTRO_ID, 
        MATERIALTYPE,-- TIPOMATERIAL_ID, 
        PRICE_CTRL_MSOCIEDAD,-- CONTROL_PRECIOS, 
        INVENTORYSPECIALSTOCKTYPE,-- STOCKESPECIAL, 
        SPECIALSTOCKIDFGCUSTOMER,-- NUMSTOCKESPECIAL, 
        STOCKIDENTIFYINGBATCH,-- LOTE, 
        '',-- LOTECENTRO_ID, 
        MATERIALBASEUNIT,-- UNI_UMB, 
        CASE WHEN WERKS LIKE 'R%' THEN 'M2' WHEN WERKS LIKE 'A%' THEN 'TON' END,-- UNI_EST, 
        CURRENCY_MGRUPO,-- MON_MXN, 
        CURRENCY_MSOCIEDAD,-- MON_LOC, 
        CURRENCY_MFUERTE,-- MON_USD, 
        Z.SISORIGEN_ID,-- SISORIGEN_ID, 
        Z.MANDANTE,-- MANDANTE, 
        CURRENT_TIMESTAMP,-- FECHA_CARGA, 
        RIGHT(CURRENT_TIMESTAMP,5); -- ZONA_HORARIA  

        -- Conteo de filas insertadas
        SELECT COUNT(*) INTO :ROWS_INSERTED FROM PRE.PFCT_LOG_INVENTARIO;

        SELECT CURRENT_TIMESTAMP() INTO :F_FIN;
        SELECT DATEDIFF(millisecond, :F_INICIO, :F_FIN) INTO :T_EJECUCION;
    EXCEPTION
        WHEN statement_error THEN
            RETURN 'Error en INSERT: ' || :sqlerrm;
    END;

    ---------------------------------------------------------------------------------
    -- STEP 3: FINALIZACIÓN
    ---------------------------------------------------------------------------------
    RETURN CONCAT('Complete - Filas insertadas: ', ROWS_INSERTED);

END;
$$;