create or replace task MIRRORING.TASK_FCT_COM_ADH_VENTAS_PCP
	warehouse=LAMOSALAKE_DEV_WH
	when SYSTEM$STREAM_HAS_DATA('STREAM_FCT_COM_ADH_VENTAS_PCP')
	as BEGIN

    -- 1. Truncar tabla temporal
   TRUNCATE TABLE TR_FCT_COM_ADH_VENTAS_PCP;

    -- 2. Insertar datos desde el stream a la temporal
    INSERT INTO TR_FCT_COM_ADH_VENTAS_PCP
    SELECT * FROM MIRRORING.STREAM_FCT_COM_ADH_VENTAS_PCP ;


    -- 3. Borrar completamente la tabla destino
-- 1. BORRAR registros eliminados
    DELETE FROM MIRRORING.FCT_COM_ADH_COMERCIAL d
    USING (
      SELECT * FROM MIRRORING.TR_FCT_COM_ADH_VENTAS_PCP 
      WHERE METADATA$ACTION = 'DELETE' AND MODELO = 'VENTASPCP' AND SISORIGEN_ID= 'FILE'
    ) s
    WHERE 
      d.anio = s.anio and
      d.aniomes = s.aniomes and
      d.fecha_comercial = s.fecha_comercial and
      d.oficinaventas_id = s.oficinaventas_id and
      d.orgventas_id = s.orgventas_id and
      d.centro_id = s.centro_id and
      d.material_id = s.material_id and
      d.sociedad_id = s.sociedad_id and
      d.region_id = s.region_id and
      d.asesorfactura_id = s.asesorfactura_id and
      d.solicitante_id = s.solicitante_id and
      d.MODELO = s.MODELO AND 
      d.SISORIGEN_ID = s.SISORIGEN_ID 
    ;

    -- 4. Insertar nuevos datos directamente (todos los INSERT del stream)
    INSERT INTO MIRRORING.FCT_COM_ADH_COMERCIAL 
    (
        -- (lista completa de columnas como ya la ten√≠as)
      ANIO,
      ANIOMES,
      FECHA_COMERCIAL,
      MES,
      ALMACENCENTRO_ID,
      ALMACEN_ID,
      CANALDISTRIB_ID,
      CENTRO_ID,
      GRUPOVENDEDORES_ID,
      OFICINAVENTAS_ID,
      ORGVENTAS_ID,
      SECTOR_ID,
      SOCIEDAD_ID,
      UENADHESIVOS_ID,
      ZONAVENTAS_ID,
      PAIS_ID,
      REGION_ID,
      ZONATRANSPORTE_ID,
      EJECUTIVOCIS_ID,
      ASESORFACTURA_ID,
      TIENDARECIBO_ID,
      INCOTERMS_ID,
      ASESORPEDIDO_ID,
      MOTIVOPEDIDO_ID,
      CONDICIONEXP_ID,
      TIPOPOSICION_ID,
      BOR_BLOQUEOENTREGA_ID,
      BOR_BLOQUEOENTREGA_POS_ID,
      BOR_CLASEPEDIDO_ID,
      BOR_FECHA_BACKORDER,
      BOR_FECHA_CREACION_PEDIDO,
      BOR_FECHA_DOCUMENTO,
      BOR_FECHA_PEDIDO_CLIENTE,
      BOR_FECHA_PREFERENTE_ENTREGA,
      BOR_MOTIVORECHAZO_ID,
      BOR_PEDIDO,
      BOR_PEDIDO_POS,
      BOR_RANGOANTPED_ID,
      BOR_STATUSCREDITO_ID,
      BOR_STATUS_BLOQUEADO_TOTAL,
      PED_CLASEDOC_CONSOLIDADO,
      PED_DOCUMENTO,
      PED_DOCUMENTO_POS,
      PED_FECHA_DOCUMENTO,
      PED_TIPODOCUMENTO,
      VTA_CLASEFACTURA_ASOCIADO_ID,
      VTA_CLASEFACTURA_ID,
      VTA_CLASEFACTURA_ORIGEN_ID,
      VTA_FACTURA,
      VTA_FACTURA_POS,
      VTA_FECHA_FACTURA,
      VTA_INDICADOR_ANULACION,
      VTA_ORDENCOMPRA,
      VTA_PEDIDO,
      VTA_PEDIDO_POS,
      VTA_STATUSCONTABILIDAD,
      VTA_GRUPO_TRANSACCION,      
      VTA_TIPO_TRANSACCION,
      CONSTRUCTORA_ID,
      CONVENIO_OBRA,
      NIO_OBRA,
      PLAN_OBRA,
      PROMOTOR_ID,
      SEGMENTO_OBRA_ID,
      TIPO_OBRA_ID,
      CHOFER,
      CLASEEXPEDICION_ID,
      CLASETRANSPORTE_ID,
      FECHA_DESPACHOEXPREAL,
      NUM_TRANSPORTE,
      PUESTOPLANTRANSP_ID,
      RUTA_ID,
      TIPOTRANSPORTE_ID,
      TIPOVEHICULO_ID,
      TRANSPORTISTA_ID,
      CLIENTE_ID,
      DESTINATARIO_ID,
      DEUDOR_ID,
      SOLICITANTE_ID,
      GRUPOARTICULOS_ID,
      MATERIALCENTRO_ID,
      MATERIALVENTAS_ID,
      MATERIAL_ID,
      TIPOMATERIAL_ID,
      UNI_EST,
      UNI_UMV,
      BOR_IND_BO_CONFIRMADO_TON,
      BOR_IND_BO_ENTREGA_TON,
      BOR_IND_BO_IMPORTE_DOC,
      BOR_IND_BO_NO_CONFIRMADO_TON,
      BOR_IND_BO_TOTAL_TON,
      BOR_MON_DOC,
      --BOR_UNI_EST,
      PED_IND_CANT_CONFIRMADA_TON,
      PED_IND_CANT_CONFIRMADA_UMV,
      PED_IND_CANT_ENTREGADA_TON,
      PED_IND_CANT_ENTREGADA_UMV,
      PED_IND_CANT_FACTURADA_TON,
      PED_IND_CANT_FACTURADA_UMV,
      PED_IND_CANT_PEDIDO_TON,
      PED_IND_CANT_PEDIDO_UMV,
      --PED_UNI_EST,
      --PED_UNI_UMV,
      VTA_IND_COSTOSINTERNOS_LOC,
      VTA_IND_COSTOSINTERNOS_MXN,
      VTA_IND_COSTOSINTERNOS_USD,
      VTA_IND_PESO_BRUTO,
      VTA_IND_PESO_NETO,
      VTA_IND_VENTA_CORRECTIVAS_LOC,
      VTA_IND_VENTA_CORRECTIVAS_MXN,
      VTA_IND_VENTA_CORRECTIVAS_USD,
      VTA_IND_VENTA_DESCUENTOFIN_PRONTOPAGO_LOC,
      VTA_IND_VENTA_DESCUENTOFIN_PRONTOPAGO_MXN,
      VTA_IND_VENTA_DESCUENTOFIN_PRONTOPAGO_USD,
      VTA_IND_VENTA_DESCUENTOS_LOC,
      VTA_IND_VENTA_DESCUENTOS_MXN,
      VTA_IND_VENTA_DESCUENTOS_USD,
      VTA_IND_VENTA_FLETES_LOC,
      VTA_IND_VENTA_FLETES_MXN,
      VTA_IND_VENTA_FLETES_USD,
      VTA_IND_VENTA_IMPUESTOS_LOC,
      VTA_IND_VENTA_IMPUESTOS_MXN,
      VTA_IND_VENTA_IMPUESTOS_USD,
      VTA_IND_VENTA_PCP_LOC,
      VTA_IND_VENTA_PCP_TON,
      VTA_IND_VENTA_PCP_USD,
      VTA_IND_VENTA_PRECIOCONSTRUCTORA_LOC,
      VTA_IND_VENTA_PRECIOCONSTRUCTORA_MXN,
      VTA_IND_VENTA_PRECIOCONSTRUCTORA_USD,
      VTA_IND_VENTA_PRECIOFACTURA_IMPUESTO_LOC,
      VTA_IND_VENTA_PRECIOFACTURA_IMPUESTO_MXN,
      VTA_IND_VENTA_PRECIOFACTURA_IMPUESTO_USD,
      VTA_IND_VENTA_PRECIOFACTURA_LOC,
      VTA_IND_VENTA_PRECIOFACTURA_MXN,
      VTA_IND_VENTA_PRECIOFACTURA_USD,
      VTA_IND_VENTA_PRECIOLISTA_LOC,
      VTA_IND_VENTA_PRECIOLISTA_MXN,
      VTA_IND_VENTA_PRECIOLISTA_USD,
      VTA_IND_VENTA_PRECIONETO_LOC,
      VTA_IND_VENTA_PRECIONETO_MXN,
      VTA_IND_VENTA_PRECIONETO_USD,
      VTA_IND_VENTA_PRECIOTEORICO_LOC,
      VTA_IND_VENTA_PRECIOTEORICO_MXN,
      VTA_IND_VENTA_PRECIOTEORICO_USD,
      VTA_IND_VENTA_PROMOCIONES_LOC,
      VTA_IND_VENTA_PROMOCIONES_MXN,
      VTA_IND_VENTA_PROMOCIONES_USD,
      VTA_IND_VENTA_REAL_FLETES_IMPUESTOS_LOC,
      VTA_IND_VENTA_REAL_FLETES_IMPUESTOS_MXN,
      VTA_IND_VENTA_REAL_FLETES_IMPUESTOS_USD,
      VTA_IND_VENTA_REAL_FLETES_LOC,
      VTA_IND_VENTA_REAL_FLETES_MXN,
      VTA_IND_VENTA_REAL_FLETES_USD,
      VTA_IND_VENTA_REAL_IMPUESTO_LOC,
      VTA_IND_VENTA_REAL_IMPUESTO_MXN,
      VTA_IND_VENTA_REAL_IMPUESTO_USD,
      VTA_IND_VENTA_REAL_LOC,
      VTA_IND_VENTA_REAL_MXN,
      VTA_IND_VENTA_REAL_TON,
      VTA_IND_VENTA_REAL_UMV,
      VTA_IND_VENTA_REAL_USD,
      VTA_IND_VENTA_REBATES_LOC,
      VTA_IND_VENTA_REBATES_MXN,
      VTA_IND_VENTA_REBATES_USD,
      VTA_MON_LOC,
      VTA_MON_MXN,
      VTA_MON_USD,
      --VTA_UNI_EST,
      VTA_UNI_PESO,
      --VTA_UNI_UMV,
      FECHA_CARGA,
      MANDANTE,
      MODELO,
      SISORIGEN_ID,
      ZONA_HORARIA
        ) 
    SELECT
      ANIO,
      ANIOMES,
      FECHA_COMERCIAL,
      MES,
      ALMACENCENTRO_ID,
      ALMACEN_ID,
      CANALDISTRIB_ID,
      CENTRO_ID,
      GRUPOVENDEDORES_ID,
      OFICINAVENTAS_ID,
      ORGVENTAS_ID,
      SECTOR_ID,
      SOCIEDAD_ID,
      UENADHESIVOS_ID,
      ZONAVENTAS_ID,
      PAIS_ID,
      REGION_ID,
      ZONATRANSPORTE_ID,
      EJECUTIVOCIS_ID,
      ASESORFACTURA_ID,
      TIENDARECIBO_ID,
      INCOTERMS_ID,
      ASESORPEDIDO_ID,
      MOTIVOPEDIDO_ID,
      CONDICIONEXP_ID,
      TIPOPOSICION_ID,
      BOR_BLOQUEOENTREGA_ID,
      BOR_BLOQUEOENTREGA_POS_ID,
      BOR_CLASEPEDIDO_ID,
      BOR_FECHA_BACKORDER,
      BOR_FECHA_CREACION_PEDIDO,
      BOR_FECHA_DOCUMENTO,
      BOR_FECHA_PEDIDO_CLIENTE,
      BOR_FECHA_PREFERENTE_ENTREGA,
      BOR_MOTIVORECHAZO_ID,
      BOR_PEDIDO,
      BOR_PEDIDO_POS,
      BOR_RANGOANTPED_ID,
      BOR_STATUSCREDITO_ID,
      BOR_STATUS_BLOQUEADO_TOTAL,
      PED_CLASEDOC_CONSOLIDADO,
      PED_DOCUMENTO,
      PED_DOCUMENTO_POS,
      PED_FECHA_DOCUMENTO,
      PED_TIPODOCUMENTO,
      VTA_CLASEFACTURA_ASOCIADO_ID,
      VTA_CLASEFACTURA_ID,
      VTA_CLASEFACTURA_ORIGEN_ID,
      VTA_FACTURA,
      VTA_FACTURA_POS,
      VTA_FECHA_FACTURA,
      VTA_INDICADOR_ANULACION,
      VTA_ORDENCOMPRA,
      VTA_PEDIDO,
      VTA_PEDIDO_POS,
      VTA_STATUSCONTABILIDAD,
      VTA_GRUPO_TRANSACCION,      
      VTA_TIPO_TRANSACCION,
      CONSTRUCTORA_ID,
      CONVENIO_OBRA,
      NIO_OBRA,
      PLAN_OBRA,
      PROMOTOR_ID,
      SEGMENTO_OBRA_ID,
      TIPO_OBRA_ID,
      CHOFER,
      CLASEEXPEDICION_ID,
      CLASETRANSPORTE_ID,
      FECHA_DESPACHOEXPREAL,
      NUM_TRANSPORTE,
      PUESTOPLANTRANSP_ID,
      RUTA_ID,
      TIPOTRANSPORTE_ID,
      TIPOVEHICULO_ID,
      TRANSPORTISTA_ID,
      CLIENTE_ID,
      DESTINATARIO_ID,
      DEUDOR_ID,
      SOLICITANTE_ID,
      GRUPOARTICULOS_ID,
      MATERIALCENTRO_ID,
      MATERIALVENTAS_ID,
      MATERIAL_ID,
      TIPOMATERIAL_ID,
      UNI_EST,
      UNI_UMV,
      BOR_IND_BO_CONFIRMADO_TON,
      BOR_IND_BO_ENTREGA_TON,
      BOR_IND_BO_IMPORTE_DOC,
      BOR_IND_BO_NO_CONFIRMADO_TON,
      BOR_IND_BO_TOTAL_TON,
      BOR_MON_DOC,
      --BOR_UNI_EST,
      PED_IND_CANT_CONFIRMADA_TON,
      PED_IND_CANT_CONFIRMADA_UMV,
      PED_IND_CANT_ENTREGADA_TON,
      PED_IND_CANT_ENTREGADA_UMV,
      PED_IND_CANT_FACTURADA_TON,
      PED_IND_CANT_FACTURADA_UMV,
      PED_IND_CANT_PEDIDO_TON,
      PED_IND_CANT_PEDIDO_UMV,
      --PED_UNI_EST,
      --PED_UNI_UMV,
      VTA_IND_COSTOSINTERNOS_LOC,
      VTA_IND_COSTOSINTERNOS_MXN,
      VTA_IND_COSTOSINTERNOS_USD,
      VTA_IND_PESO_BRUTO,
      VTA_IND_PESO_NETO,
      VTA_IND_VENTA_CORRECTIVAS_LOC,
      VTA_IND_VENTA_CORRECTIVAS_MXN,
      VTA_IND_VENTA_CORRECTIVAS_USD,
      VTA_IND_VENTA_DESCUENTOFIN_PRONTOPAGO_LOC,
      VTA_IND_VENTA_DESCUENTOFIN_PRONTOPAGO_MXN,
      VTA_IND_VENTA_DESCUENTOFIN_PRONTOPAGO_USD,
      VTA_IND_VENTA_DESCUENTOS_LOC,
      VTA_IND_VENTA_DESCUENTOS_MXN,
      VTA_IND_VENTA_DESCUENTOS_USD,
      VTA_IND_VENTA_FLETES_LOC,
      VTA_IND_VENTA_FLETES_MXN,
      VTA_IND_VENTA_FLETES_USD,
      VTA_IND_VENTA_IMPUESTOS_LOC,
      VTA_IND_VENTA_IMPUESTOS_MXN,
      VTA_IND_VENTA_IMPUESTOS_USD,
      VTA_IND_VENTA_PCP_LOC,
      VTA_IND_VENTA_PCP_TON,
      VTA_IND_VENTA_PCP_USD,
      VTA_IND_VENTA_PRECIOCONSTRUCTORA_LOC,
      VTA_IND_VENTA_PRECIOCONSTRUCTORA_MXN,
      VTA_IND_VENTA_PRECIOCONSTRUCTORA_USD,
      VTA_IND_VENTA_PRECIOFACTURA_IMPUESTO_LOC,
      VTA_IND_VENTA_PRECIOFACTURA_IMPUESTO_MXN,
      VTA_IND_VENTA_PRECIOFACTURA_IMPUESTO_USD,
      VTA_IND_VENTA_PRECIOFACTURA_LOC,
      VTA_IND_VENTA_PRECIOFACTURA_MXN,
      VTA_IND_VENTA_PRECIOFACTURA_USD,
      VTA_IND_VENTA_PRECIOLISTA_LOC,
      VTA_IND_VENTA_PRECIOLISTA_MXN,
      VTA_IND_VENTA_PRECIOLISTA_USD,
      VTA_IND_VENTA_PRECIONETO_LOC,
      VTA_IND_VENTA_PRECIONETO_MXN,
      VTA_IND_VENTA_PRECIONETO_USD,
      VTA_IND_VENTA_PRECIOTEORICO_LOC,
      VTA_IND_VENTA_PRECIOTEORICO_MXN,
      VTA_IND_VENTA_PRECIOTEORICO_USD,
      VTA_IND_VENTA_PROMOCIONES_LOC,
      VTA_IND_VENTA_PROMOCIONES_MXN,
      VTA_IND_VENTA_PROMOCIONES_USD,
      VTA_IND_VENTA_REAL_FLETES_IMPUESTOS_LOC,
      VTA_IND_VENTA_REAL_FLETES_IMPUESTOS_MXN,
      VTA_IND_VENTA_REAL_FLETES_IMPUESTOS_USD,
      VTA_IND_VENTA_REAL_FLETES_LOC,
      VTA_IND_VENTA_REAL_FLETES_MXN,
      VTA_IND_VENTA_REAL_FLETES_USD,
      VTA_IND_VENTA_REAL_IMPUESTO_LOC,
      VTA_IND_VENTA_REAL_IMPUESTO_MXN,
      VTA_IND_VENTA_REAL_IMPUESTO_USD,
      VTA_IND_VENTA_REAL_LOC,
      VTA_IND_VENTA_REAL_MXN,
      VTA_IND_VENTA_REAL_TON,
      VTA_IND_VENTA_REAL_UMV,
      VTA_IND_VENTA_REAL_USD,
      VTA_IND_VENTA_REBATES_LOC,
      VTA_IND_VENTA_REBATES_MXN,
      VTA_IND_VENTA_REBATES_USD,
      VTA_MON_LOC,
      VTA_MON_MXN,
      VTA_MON_USD,
      --VTA_UNI_EST,
      VTA_UNI_PESO,
      --VTA_UNI_UMV,
      FECHA_CARGA,
      MANDANTE,
      MODELO,
      SISORIGEN_ID,
      ZONA_HORARIA
    FROM MIRRORING.TR_FCT_COM_ADH_VENTAS_PCP
    WHERE MODELO = 'VENTASPCP' AND SISORIGEN_ID= 'FILE' AND METADATA$ACTION = 'INSERT'    ;

--ACTUALIZAR CALENDARIO
CALL MIRRORING.SP_ACTUALIZAR_CALENDARIO('FCT_COM_ADH_COMERCIAL', 'DIM_CAL_ADH_COMERCIAL');    

end;


ALTER TASK MIRRORING.TASK_FCT_COM_ADH_VENTAS_PCP RESUME;
