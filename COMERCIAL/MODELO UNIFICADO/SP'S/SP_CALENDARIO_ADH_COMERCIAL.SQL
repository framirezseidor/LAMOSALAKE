CREATE OR REPLACE PROCEDURE MIRRORING.SP_ACTUALIZAR_CALENDARIO(NOMBREFACT VARCHAR(100),  NOMBRECAL VARCHAR(100), CAMPOFECHA VARCHAR(100))
RETURNS VARCHAR(100)
LANGUAGE SQL
EXECUTE AS OWNER
AS
$$
/*declare 
    NOMBREFACT VARCHAR(100) := 'FCT_COM_ADH_COMERCIAL';
    NOMBRECAL VARCHAR(100) := 'DIM_CAL_ADH_COMERCIAL';*/
DECLARE
TEXTOEXEC VARCHAR :=
'DECLARE FECHA_INICIO DATE;
        FECHA_FIN DATE;
        DIASDIF INT;

BEGIN

    /* BUSCAMOS FECHA INICIA Y FINAL DE LA FACT */
    SELECT 
        MIN('|| :CAMPOFECHA || ') INTO :FECHA_INICIO 
    FROM 
        MIRRORING.'|| :NOMBREFACT ||';

    SELECT 
        MAX('|| :CAMPOFECHA || ') INTO :FECHA_FIN
    FROM 
        MIRRORING.'||:NOMBREFACT||';      


    /* VACIAMOS LA DIMENSION DE TIEMPO */
    TRUNCATE TABLE MIRRORING.'||:NOMBRECAL||';

    /* INSERTAMOS  */
    INSERT INTO MIRRORING.'||:NOMBRECAL||'
    SELECT 
        * 
    FROM 
        MIRRORING.VW_CAL_GRAL_MIRRORING
    WHERE
        (MES >= MONTH(:FECHA_INICIO) AND  ANIO>= YEAR(:FECHA_INICIO))
        AND
        (MES <= MONTH(:FECHA_FIN) AND  ANIO<= YEAR(:FECHA_FIN));
END;';

BEGIN
    EXECUTE IMMEDIATE TEXTOEXEC;
END;
$$;


CALL MIRRORING.SP_ACTUALIZAR_CALENDARIO('FCT_COM_ADH_COMERCIAL', 'DIM_CAL_ADH_COMERCIAL', 'FECHA_COMERCIAL');
SELECT * FROM MIRRORING.DIM_CAL_ADH_COMERCIAL;
