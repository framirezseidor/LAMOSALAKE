CREATE OR REPLACE PROCEDURE MIRRORING.SP_FCT_ADH_COM_FCT_ADH_APIC()
RETURNS VARCHAR(100)
LANGUAGE SQL
EXECUTE AS OWNER
AS
$$
BEGIN
    DELETE FROM MIRRORING.FCT_ADH_APIC
    WHERE 
        MODELO IN (SELECT DISTINCT MODELO FROM MIRRORING.FCT_COM_ADH_COMERCIAL)
        AND SISORIGEN_ID <> 'BW4' AND MODELO IN ('VENTAS', 'VENTASHIST')
        AND ANIOMES >= REPLACE(LEFT(DATEADD(YEAR,-1,TO_DATE(SYSDATE())),7),'-','')
     ;


    INSERT INTO MIRRORING.FCT_ADH_APIC 
    SELECT
        CONCAT(ANIOMES, ALMACENCENTRO_ID,MATERIAL_ID) AS APIC_ID,
        ANIO AS ANIO,
        MES AS MES,
        ANIOMES AS ANIOMES,
        FECHA_COMERCIAL AS FECHA_LOGISTICA,
        ALMACENCENTRO_ID AS ALMACENCENTRO_ID,
        ALMACEN_ID AS ALMACEN_ID,
        CENTRO_ID AS CENTRO_ID,
        SOCIEDAD_ID AS SOCIEDAD_ID,
        '' AS GRUPOCOMPRAS_ID,
        '' AS ORGCOMPRAS_ID,
        '' AS PROVEEDOR_ID,
        MATERIALCENTRO_ID AS MATERIALCENTRO_ID,
        MATERIAL_ID AS MATERIAL_ID,
        '' AS CLASEMOVIMIENTO_ID,
        '' AS CLAVEOPERACION,
        '' AS GRUPO_OPERACION,
        BOR_CLASEPEDIDO_ID AS BOR_CLASEPEDIDO_ID,
        VTA_CLASEFACTURA_ID AS VTA_CLASEFACTURA_ID,
        VTA_TIPO_TRANSACCION AS VTA_TIPO_TRANSACCION,
        SUM(BOR_IND_BO_TOTAL_TON) AS BOR_IND_BO_TOTAL_TON,
        SUM(VTA_IND_VENTA_PCP_LOC) AS VTA_IND_VENTA_PCP_LOC,
        SUM(VTA_IND_VENTA_PCP_TON) AS VTA_IND_VENTA_PCP_TON,
        SUM(VTA_IND_VENTA_REAL_LOC) AS VTA_IND_VENTA_REAL_LOC,
        SUM(VTA_IND_VENTA_REAL_TON) AS VTA_IND_VENTA_REAL_TON,
        0 AS INV_IND_BLOQUEADO_TON,
        0 AS INV_IND_BLOQUEADO_UMB,
        0 AS INV_IND_CONTROL_CALIDAD_TON,
        0 AS INV_IND_CONTROL_CALIDAD_UMB,
        0 AS INV_IND_COSTO_INV_LOC,
        0 AS INV_IND_INVENTARIO_FISICO_TON,
        0 AS INV_IND_INVENTARIO_FISICO_UMB,
        0 AS INV_IND_LIBRE_UTILIZACION_TON,
        0 AS INV_IND_LIBRE_UTILIZACION_UMB,
        0 AS INV_IND_LIBRE_VENTA_TON,
        0 AS INV_IND_LIBRE_VENTA_UMB,
        0 AS INV_IND_STOCK_SEGURIDAD_TON,
        0 AS INV_IND_STOCK_SEGURIDAD_UMB,
        0 AS INV_IND_TRANSITO_TON,
        0 AS INV_IND_TRANSITO_UMB,
        0 AS ABS_IND_CANTIDAD_TOTAL,
        0 AS ABS_IND_CANT_DIAS_COLOCACION,
        0 AS ABS_IND_CANT_POSICIONES_PEDIDO,
        0 AS ABS_IND_IMPTE_COMPRA_LOC,
        0 AS ABS_IND_IMPTE_COMPRA_PED,
        0 AS ABS_IND_IMPTE_COMPRA_USD,
        0 AS ABS_IND_IMPTE_COMPRA_SIN_FLETE_LOC,
        0 AS ABS_IND_IMPTE_COMPRA_SIN_FLETE_PED,
        0 AS ABS_IND_IMPTE_COMPRA_SIN_FLETE_USD,
        0 AS ABS_IND_IMPTE_FLETE_LOC,
        0 AS ABS_IND_IMPTE_FLETE_PED,
        0 AS ABS_IND_IMPTE_FLETE_USD,
        0 AS ABS_PRECIO_ESTANDAR_MXN ,
        0 AS ABS_PRECIO_ESTANDAR_ML,
        0 AS ABS_PRECIO_ESTANDAR_USD ,
        '' AS UEN_ID ,        
        0 AS PRD_IND_IMPTE_ML,
        0 AS PRD_IND_IMPTE_COMPRA_ML,
        0 AS PRD_IND_IMPTE_USD,
        0 AS PRD_IND_IMPTE_COMPRA_USD,
        0 AS PRD_IND_CANTIDAD_UMB,
        0 AS PRD_IND_CANTIDAD_UME,
        VTA_MON_LOC AS MON_LOC,
        '' AS MON_PED,
        '' AS MON_USD,
        '' AS UNI_PED,
        UNI_EST AS UNI_EST,
        '' AS UNI_UMB,
        CURRENT_TIMESTAMP() AS FECHA_CARGA,
        MANDANTE AS MANDANTE,
        MODELO AS MODELO,
        SISORIGEN_ID AS SISORIGEN_ID,
        ZONA_HORARIA AS ZONA_HORARIA,
        CASE MONTH(FECHA_LOGISTICA)
            WHEN 1 THEN 'ENE'
            WHEN 2 THEN 'FEB'
            WHEN 3 THEN 'MAR'
            WHEN 4 THEN 'ABR'
            WHEN 5 THEN 'MAY'
            WHEN 6 THEN 'JUN'
            WHEN 7 THEN 'JUL'
            WHEN 8 THEN 'AGO'
            WHEN 9 THEN 'SEP'
            WHEN 10 THEN 'OCT'
            WHEN 11 THEN 'NOV'
            WHEN 12 THEN 'DIC'
        END AS MES_TEXTO
    FROM
        MIRRORING.FCT_COM_ADH_COMERCIAL
    WHERE 
        SISORIGEN_ID <> 'BW4'
        AND ANIOMES >= REPLACE(LEFT(DATEADD(YEAR,-1,TO_DATE(SYSDATE())),7),'-','')        
    GROUP BY
        APIC_ID,
        ANIO,
        MES,
        ANIOMES,
        FECHA_LOGISTICA,
        ALMACENCENTRO_ID,
        ALMACEN_ID,
        CENTRO_ID,
        SOCIEDAD_ID,
        GRUPOCOMPRAS_ID,
        ORGCOMPRAS_ID,
        PROVEEDOR_ID,
        MATERIALCENTRO_ID,
        MATERIAL_ID,
        CLASEMOVIMIENTO_ID,
        CLAVEOPERACION,
        GRUPO_OPERACION,
        BOR_CLASEPEDIDO_ID,
        VTA_CLASEFACTURA_ID,
        VTA_TIPO_TRANSACCION,
        UEN_ID,
        MON_LOC,
        MON_PED,
        MON_USD,
        UNI_PED,
        UNI_EST,
        UNI_UMB,
        MANDANTE,
        MODELO,
        SISORIGEN_ID,
        ZONA_HORARIA
          ;
end;

$$ ;
 