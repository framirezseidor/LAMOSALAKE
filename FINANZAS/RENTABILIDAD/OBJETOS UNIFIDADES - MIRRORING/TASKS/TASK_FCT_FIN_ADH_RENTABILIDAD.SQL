create or replace task MIRRORING.TASK_FCT_FIN_ADH_RENTABILIDAD
	warehouse=LAMOSALAKE_DEV_WH
	when SYSTEM$STREAM_HAS_DATA('STREAM_VW_FCT_FIN_ADH_RENTABILIDAD')
	as begin

    TRUNCATE TABLE MIRRORING.TR_FCT_LOG_ADH_RENTABILIDAD;

    INSERT INTO MIRRORING.TR_FCT_LOG_ADH_RENTABILIDAD
    SELECT * FROM MIRRORING.STREAM_VW_FCT_FIN_ADH_RENTABILIDAD;

    -- 1. BORRAR registros eliminados
    DELETE FROM MIRRORING.FCT_FIN_ADH_RENTABILIDAD d
    USING (
      SELECT * FROM MIRRORING.TR_FCT_LOG_ADH_RENTABILIDAD
      WHERE METADATA$ACTION = 'DELETE'
    ) s
    WHERE d.FECHA_CONTABILIZACION = s.FECHA_CONTABILIZACION AND
          d.SOCIEDADCO_ID = s.SOCIEDADCO_ID AND 
          d.SOCIEDAD_ID = s.SOCIEDAD_ID AND
          d.ORGVENTAS_ID = s.ORGVENTAS_ID AND 
          d.CANALDISTRIB_ID = s.CANALDISTRIB_ID AND 
          d.SECTOR_ID = s.SECTOR_ID AND 
          d.OFICINAVENTAS_ID = s.OFICINAVENTAS_ID AND 
          d.CENTROCOSTO_ID = s.CENTROCOSTO_ID AND 
          d.CUENTA_ID = s.CUENTA_ID AND 
          d.CLIENTE_ID = s.CLIENTE_ID AND 
          d.DESTINATARIO_ID = s.DESTINATARIO_ID AND 
          d.CONSTRUCTORA_ID = s.CONSTRUCTORA_ID AND 
          d.TIPO_OBRA_ID = s.TIPO_OBRA_ID AND 
          d.PAIS_ID = s.PAIS_ID AND  
          d.REGION_ID = s.REGION_ID AND  
          d.ZONATRANSPORTE_ID = s.ZONATRANSPORTE_ID AND  
          d.MATERIAL_ID = s.MATERIAL_ID 

    ;

    -- 2. INSERTAR o ACTUALIZAR registros nuevos o modificados
    MERGE INTO MIRRORING.FCT_FIN_ADH_RENTABILIDAD d
    USING (
      SELECT * FROM MIRRORING.TR_FCT_LOG_ADH_RENTABILIDAD
      WHERE METADATA$ACTION = 'INSERT'
    ) s
    ON    d.FECHA_CONTABILIZACION = s.FECHA_CONTABILIZACION AND
          d.SOCIEDADCO_ID = s.SOCIEDADCO_ID AND 
          d.SOCIEDAD_ID = s.SOCIEDAD_ID AND
          d.ORGVENTAS_ID = s.ORGVENTAS_ID AND 
          d.CANALDISTRIB_ID = s.CANALDISTRIB_ID AND 
          d.SECTOR_ID = s.SECTOR_ID AND 
          d.OFICINAVENTAS_ID = s.OFICINAVENTAS_ID AND 
          d.CENTROCOSTO_ID = s.CENTROCOSTO_ID AND 
          d.CUENTA_ID = s.CUENTA_ID AND 
          d.CLIENTE_ID = s.CLIENTE_ID AND 
          d.DESTINATARIO_ID = s.DESTINATARIO_ID AND 
          d.CONSTRUCTORA_ID = s.CONSTRUCTORA_ID AND 
          d.TIPO_OBRA_ID = s.TIPO_OBRA_ID AND 
          d.PAIS_ID = s.PAIS_ID AND  
          d.REGION_ID = s.REGION_ID AND  
          d.ZONATRANSPORTE_ID = s.ZONATRANSPORTE_ID AND  
          d.MATERIAL_ID = s.MATERIAL_ID 
    WHEN NOT MATCHED THEN INSERT (
        FECHA_CONTABILIZACION,
        ANIO_MES,
        EJERCICIO,
        PERIODO,
        FECHA_DOCUMENTO,
        SOCIEDADCO_ID,
        SOCIEDAD_ID,
        ORGVENTAS_ID,
        CANALDISTRIB_ID,
        SECTOR_ID,
        CENTRO_ID,
        OFICINAVENTAS_ID,
        CENTROBENEFICIO_ID,
        CENTROCOSTO_ID,
        CUENTA_ID,
        CLIENTE_ID,
        SOLICITANTE_ID,
        DESTINATARIO_ID,
        GRUPOSOLICITANTE_ID,
        CONSTRUCTORA_ID,
        TIPO_OBRA_ID,
        ID_PLAN_DE_OBRA,
        PAIS_ID,
        PAISCLIENTE_ID,
        REGION_ID,
        ZONATRANSPORTE_ID,
        MATERIAL_ID,
        CLAVE_MONEDA,
        UNIDAD_MEDIDA,
        CENTROCOSTO_GRUPO_ID,
        CUENTA_GRUPO_ID,
        CONVENIO_OBRA,
        IND_HSL,
        IND_QUANT2,
        IND_FAB_COSTOVENTAFIJO,
        IND_VTA_IMP_PRECIOLISTA_ML,
        IND_VTA_IMP_DESCUENTOS_ML,
        IND_VTA_IMP_PROMOCIONES_ML,
        IND_VTA_IMP_RAPPELES_ML,
        IND_VTA_IMP_CORRECTIVAS_ML,
        IND_VTA_IMP_VENTAREAL_ML,
        IND_VTA_IMP_VENTAREAL_TON,
        IND_VTA_PRECIO_CONSTRUCTORA_ML,
        IND_VTA_IMP_CONSTRUCTORA_ML,
        IND_FAB_MOD,
        IND_FAB_MOI,
        IND_FAB_ELECTRICIDAD,
        IND_FAB_DEPRECIACION,
        IND_FAB_MANTENIMIENTO,
        IND_FAB_GASTOSINDIRECTOS,
        IND_FAB_EMPAQUE,
        IND_FAB_CEMENTOS,
        IND_FAB_QUIMICOSMP,
        IND_FAB_CARGASQUIMICAS,
        IND_FAB_PTCOMPRADO,
        IND_FAB_CARBONATOCOMPRADO,
        IND_FAB_CARBONATOPIEDRA,
        IND_FAB_SUBCONTRATACIONMAQUILA,
        IND_FAB_OTROCOSTOSVENTA,
        IND_FAB_VARIOSADH,
        IND_FAB_PTMAQUILA,
        IND_FAB_MOD_FIL,
        IND_FAB_MOI_FIL,
        IND_FAB_ELECTRICIDAD_FIL,
        IND_FAB_DEPRECIACION_FIL,
        IND_FAB_MANTENIMIENTO_FIL,
        IND_FAB_GASTOSINDIRECTOS_FIL,
        IND_FAB_EMPAQUE_FIL,
        IND_FAB_CEMENTOS_FIL,
        IND_FAB_QUIMICOSMP_FIL,
        IND_FAB_CARGASQUIMICAS_FIL,
        IND_FAB_CARBONATOCOMPRADO_FIL,
        IND_FAB_CARBONATOENPIEDRA_FIL,
        IND_FAB_PRECIOTRANSFERENCIA_FIL,
        IND_FAB_VARIOSADH_FIL,
        IND_FAB_OTROSCOSTOSVENTA_FIL,
        IND_VAR_COMISIONES,
        IND_VAR_MANIOBRAS,
        IND_VAR_FLETES,
        IND_OPE_ADMINISTRACION,
        IND_OPE_VENTAS,
        IND_OPE_LOGISTICA,
        IND_OPE_MARKETING,
        IND_OPE_PROYECTOS,
        IND_OPE_DIRECCIONNEGOCIO,
        IND_OPE_CORPORATIVOSTAFF,
        IND_FAB_MOD_STD,
        IND_FAB_MOI_STD,
        IND_FAB_ELECTRICIDAD_STD,
        IND_FAB_DEPRECIACION_STD,
        IND_FAB_MANTENIMIENTO_STD,
        IND_FAB_GASTOSINDIRECTOS_STD,
        IND_FAB_EMPAQUE_STD,
        IND_FAB_CEMENTOS_STD,
        IND_FAB_QUIMICOSMP_STD,
        IND_FAB_CARGASQUIMICAS_STD,
        IND_FAB_PTCOMPRADO_STD,
        IND_FAB_CARBONATOCOMPRADO_STD,
        IND_FAB_CARBONATOENPIEDRA_STD,
        IND_FAB_SUBCONTRATACIONMAQUILA_STD,
        IND_FAB_VARIOSADH_STD,
        IND_FAB_PTMAQUILA_STD,
        SISORIGEN_ID,
        MANDANTE,
        FECHA_CARGA,
        ZONA_HORARIA   
        ) VALUES (
        FECHA_CONTABILIZACION,
        ANIO_MES,
        EJERCICIO,
        PERIODO,
        FECHA_DOCUMENTO,
        SOCIEDADCO_ID,
        SOCIEDAD_ID,
        ORGVENTAS_ID,
        CANALDISTRIB_ID,
        SECTOR_ID,
        CENTRO_ID,
        OFICINAVENTAS_ID,
        CENTROBENEFICIO_ID,
        CENTROCOSTO_ID,
        CUENTA_ID,
        CLIENTE_ID,
        SOLICITANTE_ID,
        DESTINATARIO_ID,
        GRUPOSOLICITANTE_ID,
        CONSTRUCTORA_ID,
        TIPO_OBRA_ID,
        ID_PLAN_DE_OBRA,
        PAIS_ID,
        PAISCLIENTE_ID,
        REGION_ID,
        ZONATRANSPORTE_ID,
        MATERIAL_ID,
        CLAVE_MONEDA,
        UNIDAD_MEDIDA,
        CENTROCOSTO_GRUPO_ID,
        CUENTA_GRUPO_ID,
        CONVENIO_OBRA,
        IND_HSL,
        IND_QUANT2,
        IND_FAB_COSTOVENTAFIJO,
        IND_VTA_IMP_PRECIOLISTA_ML,
        IND_VTA_IMP_DESCUENTOS_ML,
        IND_VTA_IMP_PROMOCIONES_ML,
        IND_VTA_IMP_RAPPELES_ML,
        IND_VTA_IMP_CORRECTIVAS_ML,
        IND_VTA_IMP_VENTAREAL_ML,
        IND_VTA_IMP_VENTAREAL_TON,
        IND_VTA_PRECIO_CONSTRUCTORA_ML,
        IND_VTA_IMP_CONSTRUCTORA_ML,
        IND_FAB_MOD,
        IND_FAB_MOI,
        IND_FAB_ELECTRICIDAD,
        IND_FAB_DEPRECIACION,
        IND_FAB_MANTENIMIENTO,
        IND_FAB_GASTOSINDIRECTOS,
        IND_FAB_EMPAQUE,
        IND_FAB_CEMENTOS,
        IND_FAB_QUIMICOSMP,
        IND_FAB_CARGASQUIMICAS,
        IND_FAB_PTCOMPRADO,
        IND_FAB_CARBONATOCOMPRADO,
        IND_FAB_CARBONATOPIEDRA,
        IND_FAB_SUBCONTRATACIONMAQUILA,
        IND_FAB_OTROCOSTOSVENTA,
        IND_FAB_VARIOSADH,
        IND_FAB_PTMAQUILA,
        IND_FAB_MOD_FIL,
        IND_FAB_MOI_FIL,
        IND_FAB_ELECTRICIDAD_FIL,
        IND_FAB_DEPRECIACION_FIL,
        IND_FAB_MANTENIMIENTO_FIL,
        IND_FAB_GASTOSINDIRECTOS_FIL,
        IND_FAB_EMPAQUE_FIL,
        IND_FAB_CEMENTOS_FIL,
        IND_FAB_QUIMICOSMP_FIL,
        IND_FAB_CARGASQUIMICAS_FIL,
        IND_FAB_CARBONATOCOMPRADO_FIL,
        IND_FAB_CARBONATOENPIEDRA_FIL,
        IND_FAB_PRECIOTRANSFERENCIA_FIL,
        IND_FAB_VARIOSADH_FIL,
        IND_FAB_OTROSCOSTOSVENTA_FIL,
        IND_VAR_COMISIONES,
        IND_VAR_MANIOBRAS,
        IND_VAR_FLETES,
        IND_OPE_ADMINISTRACION,
        IND_OPE_VENTAS,
        IND_OPE_LOGISTICA,
        IND_OPE_MARKETING,
        IND_OPE_PROYECTOS,
        IND_OPE_DIRECCIONNEGOCIO,
        IND_OPE_CORPORATIVOSTAFF,
        IND_FAB_MOD_STD,
        IND_FAB_MOI_STD,
        IND_FAB_ELECTRICIDAD_STD,
        IND_FAB_DEPRECIACION_STD,
        IND_FAB_MANTENIMIENTO_STD,
        IND_FAB_GASTOSINDIRECTOS_STD,
        IND_FAB_EMPAQUE_STD,
        IND_FAB_CEMENTOS_STD,
        IND_FAB_QUIMICOSMP_STD,
        IND_FAB_CARGASQUIMICAS_STD,
        IND_FAB_PTCOMPRADO_STD,
        IND_FAB_CARBONATOCOMPRADO_STD,
        IND_FAB_CARBONATOENPIEDRA_STD,
        IND_FAB_SUBCONTRATACIONMAQUILA_STD,
        IND_FAB_VARIOSADH_STD,
        IND_FAB_PTMAQUILA_STD,
        SISORIGEN_ID,
        MANDANTE,
        FECHA_CARGA,
        ZONA_HORARIA   
);

end;



ALTER TASK MIRRORING.TASK_FCT_FIN_ADH_RENTABILIDAD RESUME;