CREATE OR REPLACE PROCEDURE CON.SP_CON_FCT_FIN_ADH_RENTABILIDAD(
    FECHA_CONT_INI       VARCHAR(50),
    FECHA_CONT_FIN         VARCHAR(30)
)
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS
$$
/*
---------------------------------------------------------------------------------
 Versión:            1.0
 Fecha de creación:  2025-06-11
 Creador:            Carlos Panta
 Descripción:        SP que transforma datos desde la capa PRE a CON para FCT_FIN_ADH_RENTABILIDAD
---------------------------------------------------------------------------------
*/

DECLARE
    -- VARIABLES DE CONTROL
    F_INICIO        TIMESTAMP_NTZ(9);
    F_FIN           TIMESTAMP_NTZ(9);
    T_EJECUCION     NUMBER(38,0);
    ROWS_INSERTED   NUMBER(38,0);
    TEXTO           VARCHAR(200);
    PARAMETRO       VARCHAR(20);

BEGIN

    ---------------------------------------------------------------------------------
    -- STEP 1: LIMPIEZA DE DATOS EN LA TABLA CON
    ---------------------------------------------------------------------------------
    BEGIN
        SELECT CURRENT_TIMESTAMP() INTO :F_INICIO;

        DELETE FROM CON.FCT_FIN_ADH_RENTABILIDAD
        --BORRADO EN BASE A LAS FECHAS DE CONTABILIZACIÓN
        WHERE FECHA_CONTABILIZACION BETWEEN :FECHA_CONT_INI AND :FECHA_CONT_FIN;

        SELECT CURRENT_TIMESTAMP() INTO :F_FIN;
        SELECT DATEDIFF(millisecond, :F_INICIO, :F_FIN) INTO :T_EJECUCION;
    EXCEPTION
        WHEN statement_error THEN
            SELECT ('Error en DELETE: ' || :sqlerrm) INTO :TEXTO;
    END;

    ---------------------------------------------------------------------------------
    -- STEP 2: INSERCIÓN DE DATOS DESDE PRE HACIA CON
    ---------------------------------------------------------------------------------
    BEGIN
        SELECT CURRENT_TIMESTAMP() INTO :F_INICIO;

        INSERT INTO CON.FCT_FIN_ADH_RENTABILIDAD
        (
        FECHA_CONTABILIZACION,
        ANIO_MES,
        EJERCICIO,
        PERIODO,
        FECHA_DOCUMENTO,
        SOCIEDADCO_ID,
        SOCIEDAD_ID,
        ORGVENTAS_ID,
        CANALDISTRIB_ID,
        SECTOR_ID,
        CENTRO_ID,
        OFICINAVENTAS_ID,
        CENTROBENEFICIO_ID,
        CENTROCOSTO_ID,
        CUENTA_ID,
        CLIENTE_ID,
        SOLICITANTE_ID,
        DESTINATARIO_ID,
        GRUPOSOLICITANTE_ID,
        CONSTRUCTORA_ID,
        TIPO_OBRA_ID,
        ID_PLAN_DE_OBRA,
        PAIS_ID,
        PAISCLIENTE_ID,
        REGION_ID,
        ZONATRANSPORTE_ID,
        MATERIAL_ID,
        CLAVE_MONEDA,
        UNIDAD_MEDIDA,
        CENTROCOSTO_GRUPO_ID,
        CUENTA_GRUPO_ID,
        CONVENIO_OBRA,
        IND_HSL,
        IND_QUANT2,
        IND_FAB_COSTOVENTAFIJO,
        IND_VTA_IMP_PRECIOLISTA_ML,
        IND_VTA_IMP_DESCUENTOS_ML,
        IND_VTA_IMP_PROMOCIONES_ML,
        IND_VTA_IMP_RAPPELES_ML,
        IND_VTA_IMP_CORRECTIVAS_ML,
        IND_VTA_IMP_VENTAREAL_ML,
        IND_VTA_IMP_VENTAREAL_TON,
        IND_VTA_PRECIO_CONSTRUCTORA_ML,
        IND_VTA_IMP_CONSTRUCTORA_ML,
        IND_FAB_MOD,
        IND_FAB_MOI,
        IND_FAB_ELECTRICIDAD,
        IND_FAB_DEPRECIACION,
        IND_FAB_MANTENIMIENTO,
        IND_FAB_GASTOSINDIRECTOS,
        IND_FAB_EMPAQUE,
        IND_FAB_CEMENTOS,
        IND_FAB_QUIMICOSMP,
        IND_FAB_CARGASQUIMICAS,
        IND_FAB_PTCOMPRADO,
        IND_FAB_CARBONATOCOMPRADO,
        IND_FAB_CARBONATOPIEDRA,
        IND_FAB_SUBCONTRATACIONMAQUILA,
        IND_FAB_OTROCOSTOSVENTA,
        IND_FAB_VARIOSADH,
        IND_FAB_MOD_FIL,
        IND_FAB_MOI_FIL,
        IND_FAB_ELECTRICIDAD_FIL,
        IND_FAB_DEPRECIACION_FIL,
        IND_FAB_MANTENIMIENTO_FIL,
        IND_FAB_GASTOSINDIRECTOS_FIL,
        IND_FAB_EMPAQUE_FIL,
        IND_FAB_CEMENTOS_FIL,
        IND_FAB_QUIMICOSMP_FIL,
        IND_FAB_CARGASQUIMICAS_FIL,
        IND_FAB_CARBONATOCOMPRADO_FIL,
        IND_FAB_CARBONATOENPIEDRA_FIL,
        IND_FAB_PRECIOTRANSFERENCIA_FIL,
        IND_FAB_VARIOSADH_FIL,
        IND_FAB_OTROSCOSTOSVENTA_FIL,
        IND_VAR_COMISIONES,
        IND_VAR_MANIOBRAS,
        IND_VAR_FLETES,
        IND_OPE_ADMINISTRACION,
        IND_OPE_VENTAS,
        IND_OPE_LOGISTICA,
        IND_OPE_MARKETING,
        IND_OPE_PROYECTOS,
        IND_OPE_DIRECCIONNEGOCIO,
        IND_OPE_CORPORATIVOSTAFF,
        IND_FAB_MOD_STD,
        IND_FAB_MOI_STD,
        IND_FAB_ELECTRICIDAD_STD,
        IND_FAB_DEPRECIACION_STD,
        IND_FAB_MANTENIMIENTO_STD,
        IND_FAB_GASTOSINDIRECTOS_STD,
        IND_FAB_EMPAQUE_STD,
        IND_FAB_CEMENTOS_STD,
        IND_FAB_QUIMICOSMP_STD,
        IND_FAB_CARGASQUIMICAS_STD,
        IND_FAB_PTCOMPRADO_STD,
        IND_FAB_CARBONATOCOMPRADO_STD,
        IND_FAB_CARBONATOENPIEDRA_STD,
        IND_FAB_SUBCONTRATACIONMAQUILA_STD,
        IND_FAB_VARIOSADH_STD,
        SISORIGEN_ID,
        MANDANTE,
        FECHA_CARGA,
        ZONA_HORARIA   
        )
        SELECT
        FECHA_CONTABILIZACION,
        ANIO_MES,
        EJERCICIO,
        PERIODO,
        FECHA_DOCUMENTO,
        SOCIEDADCO_ID,
        SOCIEDAD_ID,
        ORGVENTAS_ID,
        CANALDISTRIB_ID,
        SECTOR_ID,
        CENTRO_ID,
        OFICINAVENTAS_ID,
        CENTROBENEFICIO_ID,
        CENTROCOSTO_ID,
        CUENTA_ID,
        CLIENTE_ID,
        SOLICITANTE_ID,
        DESTINATARIO_ID,
        GRUPOSOLICITANTE_ID,
        CONSTRUCTORA_ID,
        TIPO_OBRA_ID,
        ID_PLAN_DE_OBRA,
        PAIS_ID,
        PAISCLIENTE_ID,
        REGION_ID,
        ZONATRANSPORTE_ID,
        MATERIAL_ID,
        CLAVE_MONEDA,
        COALESCE(U.VALOR_ESTANDARD, T.UNIDAD_MEDIDA),
        CENTROCOSTO_GRUPO_ID,
        CUENTA_GRUPO_ID,
        CONVENIO_OBRA,
        IND_HSL,
        IND_QUANT2,
        IND_FAB_COSTOVENTAFIJO,
        IND_VTA_IMP_PRECIOLISTA_ML,
        IND_VTA_IMP_DESCUENTOS_ML,
        IND_VTA_IMP_PROMOCIONES_ML,
        IND_VTA_IMP_RAPPELES_ML,
        IND_VTA_IMP_CORRECTIVAS_ML,
        IND_VTA_IMP_VENTAREAL_ML,
        IND_VTA_IMP_VENTAREAL_TON,
        IND_VTA_PRECIO_CONSTRUCTORA_ML,
        IND_VTA_IMP_CONSTRUCTORA_ML,
        IND_FAB_MOD,
        IND_FAB_MOI,
        IND_FAB_ELECTRICIDAD,
        IND_FAB_DEPRECIACION,
        IND_FAB_MANTENIMIENTO,
        IND_FAB_GASTOSINDIRECTOS,
        IND_FAB_EMPAQUE,
        IND_FAB_CEMENTOS,
        IND_FAB_QUIMICOSMP,
        IND_FAB_CARGASQUIMICAS,
        IND_FAB_PTCOMPRADO,
        IND_FAB_CARBONATOCOMPRADO,
        IND_FAB_CARBONATOPIEDRA,
        IND_FAB_SUBCONTRATACIONMAQUILA,
        IND_FAB_OTROCOSTOSVENTA,
        IND_FAB_VARIOSADH,
        IND_FAB_MOD_FIL,
        IND_FAB_MOI_FIL,
        IND_FAB_ELECTRICIDAD_FIL,
        IND_FAB_DEPRECIACION_FIL,
        IND_FAB_MANTENIMIENTO_FIL,
        IND_FAB_GASTOSINDIRECTOS_FIL,
        IND_FAB_EMPAQUE_FIL,
        IND_FAB_CEMENTOS_FIL,
        IND_FAB_QUIMICOSMP_FIL,
        IND_FAB_CARGASQUIMICAS_FIL,
        IND_FAB_CARBONATOCOMPRADO_FIL,
        IND_FAB_CARBONATOENPIEDRA_FIL,
        IND_FAB_PRECIOTRANSFERENCIA_FIL,
        IND_FAB_VARIOSADH_FIL,
        IND_FAB_OTROSCOSTOSVENTA_FIL,
        IND_VAR_COMISIONES,
        IND_VAR_MANIOBRAS,
        IND_VAR_FLETES,
        IND_OPE_ADMINISTRACION,
        IND_OPE_VENTAS,
        IND_OPE_LOGISTICA,
        IND_OPE_MARKETING,
        IND_OPE_PROYECTOS,
        IND_OPE_DIRECCIONNEGOCIO,
        IND_OPE_CORPORATIVOSTAFF,
        IND_FAB_MOD_STD,
        IND_FAB_MOI_STD,
        IND_FAB_ELECTRICIDAD_STD,
        IND_FAB_DEPRECIACION_STD,
        IND_FAB_MANTENIMIENTO_STD,
        IND_FAB_GASTOSINDIRECTOS_STD,
        IND_FAB_EMPAQUE_STD,
        IND_FAB_CEMENTOS_STD,
        IND_FAB_QUIMICOSMP_STD,
        IND_FAB_CARGASQUIMICAS_STD,
        IND_FAB_PTCOMPRADO_STD,
        IND_FAB_CARBONATOCOMPRADO_STD,
        IND_FAB_CARBONATOENPIEDRA_STD,
        IND_FAB_SUBCONTRATACIONMAQUILA_STD,
        IND_FAB_VARIOSADH_STD,
        SISORIGEN_ID,
        MANDANTE,
        FECHA_CARGA,
        ZONA_HORARIA   
        FROM PRE.PFCT_FIN_ADH_RENTABILIDAD T
        LEFT JOIN RAW.CAT_UNIDAD_ESTADISTICA U ON UPPER(TRIM(T.UNIDAD_MEDIDA)) = UPPER(TRIM(U.VALOR_ORIGINAL))
        --INSERCIÓN EN BASE A LAS FECHAS DE CONTABILIZACIÓN
        WHERE FECHA_CONTABILIZACION BETWEEN :FECHA_CONT_INI AND :FECHA_CONT_FIN; 

        -- Conteo de filas insertadas
        SELECT COUNT(*) INTO :ROWS_INSERTED FROM CON.FCT_FIN_ADH_RENTABILIDAD
        WHERE FECHA_CONTABILIZACION BETWEEN :FECHA_CONT_INI AND :FECHA_CONT_FIN; 

        SELECT CURRENT_TIMESTAMP() INTO :F_FIN;
        SELECT DATEDIFF(millisecond, :F_INICIO, :F_FIN) INTO :T_EJECUCION;
    EXCEPTION
        WHEN statement_error THEN
           SELECT ('Error en INSERT: ' || :sqlerrm) INTO :TEXTO;
    END;

    ---ACTUALIZACIÓN TABLA CALENDARIO

    CALL MIRRORING.SP_ACTUALIZAR_CALENDARIO('FCT_FIN_ADH_RENTABILIDAD', 'DIM_CAL_ADH_RENTABILIDAD', 'FECHA_CONTABILIZACION');

    ---------------------------------------------------------------------------------
    -- STEP 3: LOG
    ---------------------------------------------------------------------------------
        SELECT COALESCE(:TEXTO,'EJECUCION CORRECTA') INTO :TEXTO;

        INSERT INTO LOGS.HISTORIAL_EJECUCIONES 
        VALUES('SP_CON_FCT_FIN_ADH_RENTABILIDAD','FCT_FIN_ADH_RENTABILIDAD', :F_INICIO, :F_FIN,:T_EJECUCION ,:ROWS_INSERTED, :TEXTO );

    ---------------------------------------------------------------------------------
    -- STEP 4: FINALIZACIÓN
    ---------------------------------------------------------------------------------
    RETURN CONCAT('Complete - Filas insertadas: ', ROWS_INSERTED);

END;
$$;
 